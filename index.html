<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voice of Customer â€” Google Reviews Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
  /* ========= Root & Colors (original green/red/yellow palette restored) ========= */
  :root{
    --bg: #f3f4f6;
    --card: #ffffff;
    --muted: #6b7280;
    --blue: #0f172a;
    --positive: #10b981; /* green used in screenshots */
    --negative: #ef4444; /* red */
    --neutral: #f59e0b;  /* yellow/orange */
    --shadow: 0 10px 30px rgba(2,6,23,0.06);
    --accent-soft: rgba(16,185,129,0.07);
    font-family: Roboto, system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial;
  }

  html,body{height:100%; margin:0; background:var(--bg); color:var(--blue); -webkit-font-smoothing:antialiased;}
  *{box-sizing:border-box}

  /* Prevent horizontal scroll globally */
  html,body,#app { overflow-x:hidden; }

  /* Page container */
  #app { max-width:1200px; margin:18px auto; padding:18px; }

  /* Header */
  .header {
    text-align:center;
    padding:18px 20px;
    border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.95));
    box-shadow: var(--shadow);
    margin-bottom:18px;
    position:relative;
  }
  .filtersBtn {
    position:absolute;
    left:18px;
    top:18px;
    border:1px solid rgba(0,0,0,0.06);
    background:var(--card);
    border-radius:10px;
    padding:8px 12px;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(2,6,23,0.04);
  }
  .title { font-size:22px; font-weight:700; margin:0; color:var(--blue) }
  .subtitle { font-size:13px; color:var(--muted); margin-top:6px }

  /* KPI row */
  .kpi-row { display:flex; gap:16px; justify-content:center; align-items:center; margin-top:18px; flex-wrap:wrap; }
  .kpi {
    width:220px; /* fixed so they stay same size */
    background:var(--card);
    border-radius:12px;
    padding:18px;
    text-align:left;
    box-shadow:0 6px 18px rgba(2,6,23,0.04);
  }
  .kpi .label { color:var(--muted); font-size:13px; margin-bottom:8px }
  .kpi .value { font-size:28px; font-weight:700; color:var(--blue) }

  .kpi.small { width:160px; padding:12px }
  .control-actions { display:flex; gap:12px; justify-content:center; margin-top:12px; }

  .btn { background:var(--card); border-radius:10px; padding:8px 14px; border:1px solid rgba(2,6,23,0.06); cursor:pointer; font-weight:500; }
  .btn.primary { background:var(--positive); color:white; border:none }
  .btn.ghost { background:transparent; border:1px solid rgba(2,6,23,0.06) }

  /* Grid layout - original widths restored (two-column + sidebar) */
  .grid {
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:16px;
    margin-top:18px;
    align-items:start;
  }

  /* Cards */
  .card {
    background:var(--card);
    border-radius:12px;
    padding:18px;
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .card h3 { margin:0 0 12px 0; color:var(--blue); font-size:18px }
  .card .small-muted { color:var(--muted); font-size:13px; margin-bottom:10px }

  /* drivers: pills and small bar chart area */
  .driver-top { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px }
  .pill { background:#f3f4f6; padding:8px 12px; border-radius:999px; font-weight:500; color:var(--blue) }

  /* small horizontal bar list inside card */
  .drivers-list { display:flex; flex-direction:column; gap:12px; }
  .drivers-row { display:flex; align-items:center; gap:12px }
  .drivers-label { width:180px; color:var(--muted) }
  .drivers-bar {
    flex:1; height:20px; border-radius:10px; background:rgba(16,185,129,0.15); position:relative; overflow:visible;
  }
  .drivers-bar > span { position:absolute; right:10px; top:50%; transform:translateY(-50%); font-weight:700; color:var(--blue) }

  /* right column elements (pie + trend stack) */
  .right-stack { display:flex; flex-direction:column; gap:12px; }
  .pie-wrap { display:flex; gap:12px; align-items:center; justify-content:center; padding:6px 0; }
  .pie-legend { display:flex; flex-direction:column; gap:8px; font-size:14px; color:var(--muted) }

  /* word cloud chips */
  .word-cloud { display:flex; gap:10px; flex-wrap:wrap; align-items:center; min-height:120px; }
  .chip { padding:8px 12px; border-radius:20px; color:white; font-weight:600; box-shadow:0 6px 16px rgba(2,6,23,0.04) }

  /* line chart container */
  .svg-chart { width:100%; height:240px; }

  /* heatmap table (simple) */
  .heatmap-wrap{ overflow:auto; border-radius:8px; padding:8px; background:linear-gradient(180deg,#ffffff,#fbfdff) }
  .heatmap-table{ width:100%; border-collapse:collapse; }
  .heatmap-table th, .heatmap-table td{ padding:8px 10px; border:1px solid rgba(2,6,23,0.04); text-align:center; white-space:nowrap }
  .heatmap-table th { background:#fafafa }

  /* comments columns */
  .comments-row { display:flex; gap:12px; margin-top:12px; }
  .comment-column { flex:1; background:var(--card); border-radius:12px; padding:12px; box-shadow:var(--shadow); max-height:300px; overflow:auto; }
  .comment-card { background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:8px; border:1px solid rgba(2,6,23,0.04) }

  /* Strategic insights grid (restore 6 cards like screenshot) */
  .insights { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:18px; }
  .insight-card { padding:16px; border-radius:12px; background:#fff; box-shadow:var(--shadow); min-height:120px; }
  .insight-card h4 { margin:0 0 8px 0; font-size:16px }

  /* Modal (filters) - center pop-up */
  .modal-backdrop { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.35); z-index:9999; }
  .modal { width:560px; max-height:80vh; overflow:auto; background:var(--card); border-radius:12px; padding:16px; }
  .modal h3 { margin:0 0 12px 0 }

  .collapsible { border-radius:8px; background:#f8fafc; padding:10px; margin-bottom:8px; }
  .collapsible .heading { display:flex; justify-content:space-between; align-items:center; cursor:pointer; font-weight:700 }
  .collapsible .body { margin-top:8px; display:none; }

  /* Responsive */
  @media (max-width:1150px){
    .grid { grid-template-columns: 1fr; }
    .insights { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width:640px){
    .insights { grid-template-columns: 1fr; }
    .kpi { width: 46%; }
  }

</style>
</head>
<body>
<div id="app">

  <!-- Header -->
  <div class="header">
    <button class="filtersBtn" id="openFilters">Filters</button>
    <div style="text-align:center">
      <div class="title">Voice of Customer â€” Google Reviews</div>
      <div class="subtitle">Interactive Analytics Dashboard</div>
    </div>

    <!-- KPI row -->
    <div class="kpi-row" aria-hidden="false">
      <div class="kpi">
        <div class="label">Total Reviews</div>
        <div class="value" id="kpiTotal">0</div>
      </div>
      <div class="kpi">
        <div class="label">% Negative Reviews</div>
        <div class="value" id="kpiNegative">0%</div>
      </div>
      <div class="kpi">
        <div class="label">Best Store</div>
        <div class="value" id="kpiBest">â€”</div>
      </div>
      <div class="kpi">
        <div class="label">Worst Store</div>
        <div class="value" id="kpiWorst">â€”</div>
      </div>
    </div>

    <div class="control-actions">
      <button class="btn" id="downloadCsvBtn">Download CSV</button>
      <button class="btn" id="resetFiltersBtn">Reset Filters</button>
    </div>
  </div>

  <!-- Strategic insights row (Option 1: right below KPIs) -->
  <div>
    <h3 style="margin:12px 0 8px 6px; color:var(--blue)">Strategic Insights</h3>
    <div class="insights" id="insightsGrid">
      <!-- 6 cards generated by JS -->
    </div>
  </div>

  <!-- Grid: Left main and right column -->
  <div class="grid" style="margin-top:16px">
    <!-- Left column: main charts -->
    <div>
      <!-- Drivers card -->
      <div class="card">
        <h3>Key Drivers of Customer Feedback (All Sentiments)</h3>
        <div class="driver-top" id="driverPills"></div>
        <div class="drivers-list" id="driversList" style="margin-top:8px"></div>
      </div>

      <!-- Row: Word cloud + Line chart -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
        <div class="card">
          <h3>Emotion Word Cloud</h3>
          <div class="word-cloud" id="wordCloud"></div>
        </div>
        <div class="card">
          <h3>Sentiment Trend over Time</h3>
          <div id="lineChart" class="svg-chart" aria-hidden="true"></div>
          <div style="text-align:center; margin-top:6px; color:var(--muted);">APR â€” MAY â€” JUN (static)</div>
        </div>
      </div>

      <!-- Heatmap + Zone chart side-by-side -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px">
        <div class="card">
          <h3>Store Sentiment Heatmap (Top 10 stores Ã— Categories)</h3>
          <div class="heatmap-wrap">
            <table class="heatmap-table" id="heatmapTable"></table>
          </div>
        </div>
        <div class="card">
          <h3>Sentiment by Zone</h3>
          <div id="zoneChart" class="svg-chart"></div>
        </div>
      </div>

      <!-- Comments -->
      <div class="comments-row" style="margin-top:12px">
        <div class="comment-column">
          <h3 style="margin-top:0">Positive Comments (Top 15)</h3>
          <div id="positiveComments"></div>
        </div>
        <div class="comment-column">
          <h3 style="margin-top:0">Negative Comments (Top 15)</h3>
          <div id="negativeComments"></div>
        </div>
      </div>
    </div>

    <!-- Right column: Pie + Sentiment trend small + placeholders for list -->
    <div class="right-stack">
      <div class="card">
        <h3>Sentiment Distribution</h3>
        <div class="pie-wrap">
          <div id="pieChart" style="width:220px;height:220px"></div>
          <div id="pieLegend" class="pie-legend"></div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-bottom:10px">Top Stores (by volume)</h3>
        <div style="max-height:300px; overflow:auto; padding-right:6px" id="topStoresList"></div>
      </div>

      <div class="card">
        <h3>Driver Snapshot</h3>
        <div id="driverSnapshot" class="small-muted">Quick snapshot of top drivers</div>
      </div>
    </div>
  </div>

  <div style="height:36px"></div> <!-- spacing -->

</div>

<!-- Filters modal (mobile-style centered) -->
<div class="modal-backdrop" id="filtersModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="filterTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="filterTitle">Filters</h3>
      <div style="display:flex;gap:8px">
        <button class="btn" id="applyFilters">Apply</button>
        <button class="btn" id="closeFilters">Close</button>
      </div>
    </div>

    <!-- Collapsible sections -->
    <div class="collapsible">
      <div class="heading">Business Name <span class="muted">(single select)</span></div>
      <div class="body" id="businessNameBody"></div>
    </div>

    <div class="collapsible">
      <div class="heading">Zone</div>
      <div class="body" id="zoneBody"></div>
    </div>

    <div class="collapsible">
      <div class="heading">State</div>
      <div class="body" id="stateBody"></div>
    </div>

    <div class="collapsible">
      <div class="heading">City</div>
      <div class="body" id="cityBody"></div>
    </div>

    <div class="collapsible">
      <div class="heading">Sentiment</div>
      <div class="body" id="sentimentBody"></div>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn primary" id="applyBtn">Apply Filters</button>
    </div>
  </div>
</div>

<script>
/* ========= Config & constants ========= */
const RAW_JSON_URL = "https://raw.githubusercontent.com/Harishbose/voc-dashboard/main/reviews.json";
const MONTH_ORDER = ['APR','MAY','JUN']; // static as per Option A
const SENT_COLORS = { Positive: getComputedStyle(document.documentElement).getPropertyValue('--positive').trim() || '#10b981', Negative: getComputedStyle(document.documentElement).getPropertyValue('--negative').trim() || '#ef4444', Neutral: getComputedStyle(document.documentElement).getPropertyValue('--neutral').trim() || '#f59e0b' };

/* ========= State ========= */
let state = {
  raw: [],
  data: [],
  filters: {
    businessName: null,
    zones: new Set(),
    states: new Set(),
    cities: new Set(),
    sentiments: new Set()
  },
  derived: {}
};

/* ========= Helpers ========= */
function escapeHtml(s){ return String(s||''); }
function uniq(arr){ return Array.from(new Set(arr.filter(x=>x && x!==undefined && x!==null))); }
function sentimentScore(s){ if(s==='Positive') return 1; if(s==='Negative') return -1; return 0; }
function classifyImprovementCategory(text){
  if(!text) return 'Miscellaneous';
  const t = text.toLowerCase();
  if(['staff','service','salesman','experience','assistance','interaction','attitude','rude','polite','courtesy','professionalism'].some(k=>t.includes(k))) return 'Store Experience';
  if(['quality','material','product','durability','defect','faulty'].some(k=>t.includes(k))) return 'Product Quality';
  if(['collection','variety','size','available','stock','availability'].some(k=>t.includes(k))) return 'Inventory Management';
  if(['price','cost','expensive','discount','deal','value'].some(k=>t.includes(k))) return 'Pricing & Discounts';
  if(['return','exchange','refund','policy','returnable'].some(k=>t.includes(k))) return 'Return & Refund';
  if(['wait','queue','delay','slow','line','turnaround'].some(k=>t.includes(k))) return 'Wait Queue';
  if(['promotion','offer','loyalty','coupon','reward'].some(k=>t.includes(k))) return 'Promo Offers';
  if(['billing','payment','charge','invoice','transaction'].some(k=>t.includes(k))) return 'Billing Issue';
  if(['support','help','assistance','responsive','query','resolution'].some(k=>t.includes(k))) return 'Customer Support';
  return 'Miscellaneous';
}
function detectEmotions(text){
  const t = (text||'').toLowerCase();
  const out=[];
  if(/thank|thanks|gratef|appreciat|love|ðŸ˜Š/.test(t)) out.push('Gratitude');
  if(/angry|hate|annoy|furious|ðŸ˜ |mad|rage|terrible|awful|worst/.test(t)) out.push('Frustration');
  if(/happy|great|excellent|pleased|satisfied/.test(t)) out.push('Satisfaction');
  if(/disappointed|sad|upset|not happy|disappoint/.test(t)) out.push('Disappointment');
  if(/confused|unclear|unsure/.test(t)) out.push('Confusion');
  if(/joy|joyful|joyous/.test(t)) out.push('Joy');
  return out.length ? out : ['Neutral'];
}
function formatDateYMD(s){
  if(!s) return 'N/A';
  try { const d = new Date(s); return (d.getMonth()+1)+'/'+d.getDate()+'/'+d.getFullYear(); } catch(e){ return s; }
}

/* ========= Data loading & normalization ========= */
async function loadData(){
  try{
    const res = await fetch(RAW_JSON_URL);
    if(!res.ok) throw new Error('Failed to fetch JSON');
    const arr = await res.json();
    state.raw = arr.map(normalizeRecord);
    state.data = state.raw.slice();
    refreshDerived();
    initDefaults();
    renderAll();
  }catch(err){
    console.error(err);
    alert('Failed to load reviews JSON. Check console.');
  }
}

function normalizeRecord(r){
  const rec = {};
  rec.rating = (r.rating !== undefined && !isNaN(Number(r.rating))) ? Number(r.rating) : 0;
  rec.storeCode = r.storeCode || r.store || '';
  rec.businessName = r.businessName || r.Brand || '';
  rec.zone = r.zone || '';
  rec.state = r.state || '';
  rec.city = r.city || '';
  rec.commentDate = r.commentDate || r.comment || '';
  rec.month = (r.month || '').toUpperCase();
  rec.quarter = r.quarter || '';
  rec.fy = r.fy || '';
  rec.sentiment = r.sentiment || 'Neutral';
  rec.comment = (r.comment && typeof r.comment==='string' && r.comment.length>5) ? r.comment : (r.responseType || '');
  rec.__raw = r;
  return rec;
}

function refreshDerived(){
  state.derived.businessNames = uniq(state.raw.map(r=>r.businessName)).sort();
  state.derived.zones = uniq(state.raw.map(r=>r.zone)).sort();
  state.derived.states = uniq(state.raw.map(r=>r.state)).sort();
  state.derived.cities = uniq(state.raw.map(r=>r.city)).sort();
}

/* ========= Filtering UI (modal) ========= */
function openFilters(){
  document.getElementById('filtersModal').style.display='flex';
}
function closeFilters(){
  document.getElementById('filtersModal').style.display='none';
}
function buildFiltersUI(){
  // businessName (radio)
  const bn = document.getElementById('businessNameBody'); bn.innerHTML='';
  state.derived.businessNames.forEach(name=>{
    const id = 'bn_' + name.replace(/\W+/g,'_');
    const div = document.createElement('div');
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="radio" name="businessName" value="${escapeHtml(name)}" ${state.filters.businessName===name?'checked':''}/> ${escapeHtml(name)}</label>`;
    bn.appendChild(div);
  });

  // zones (checkboxes)
  const zb = document.getElementById('zoneBody'); zb.innerHTML='';
  state.derived.zones.forEach(z=>{
    const div = document.createElement('div');
    const checked = state.filters.zones.has(z) ? 'checked' : '';
    div.innerHTML = `<label><input type="checkbox" data-val="${z}" class="zone-cb" ${checked}/> ${escapeHtml(z)}</label>`;
    zb.appendChild(div);
  });

  // states
  const sb = document.getElementById('stateBody'); sb.innerHTML='';
  state.derived.states.forEach(s=>{
    const div=document.createElement('div');
    const checked = state.filters.states.has(s) ? 'checked' : '';
    div.innerHTML = `<label><input type="checkbox" data-val="${s}" class="state-cb" ${checked}/> ${escapeHtml(s)}</label>`;
    sb.appendChild(div);
  });

  // cities
  const cb = document.getElementById('cityBody'); cb.innerHTML='';
  state.derived.cities.forEach(c=>{
    const div = document.createElement('div');
    const checked = state.filters.cities.has(c) ? 'checked' : '';
    div.innerHTML = `<label><input type="checkbox" data-val="${c}" class="city-cb" ${checked}/> ${escapeHtml(c)}</label>`;
    cb.appendChild(div);
  });

  // sentiments
  const sent = document.getElementById('sentimentBody'); sent.innerHTML='';
  ['Positive','Neutral','Negative'].forEach(s=>{
    const div = document.createElement('div');
    const checked = state.filters.sentiments.has(s) ? 'checked' : '';
    div.innerHTML = `<label><input type="checkbox" data-val="${s}" class="sent-cb" ${checked}/> ${s}</label>`;
    sent.appendChild(div);
  });

  attachFilterListeners();
}

function attachFilterListeners(){
  document.querySelectorAll('input[name="businessName"]').forEach(r=>{
    r.addEventListener('change', e=>{
      state.filters.businessName = e.target.value;
    });
  });
  document.querySelectorAll('.zone-cb').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.zones.add(v); else state.filters.zones.delete(v);
    });
  });
  document.querySelectorAll('.state-cb').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.states.add(v); else state.filters.states.delete(v);
    });
  });
  document.querySelectorAll('.city-cb').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.cities.add(v); else state.filters.cities.delete(v);
    });
  });
  document.querySelectorAll('.sent-cb').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.sentiments.add(v); else state.filters.sentiments.delete(v);
    });
  });
}

/* ========= Apply filters & compute derived ========= */
function applyFilters(){
  let out = state.raw.slice();
  const f = state.filters;
  if(f.businessName) out = out.filter(r=> r.businessName === f.businessName);
  if(f.zones.size) out = out.filter(r=> f.zones.has(r.zone));
  if(f.states.size) out = out.filter(r=> f.states.has(r.state));
  if(f.cities.size) out = out.filter(r=> f.cities.has(r.city));
  if(f.sentiments.size) out = out.filter(r=> f.sentiments.has(r.sentiment));
  state.data = out;
}

/* ========= KPIs & Strategic insights ========= */
function computeKPIs(){
  const data = state.data;
  const total = data.length;
  const negatives = data.filter(d=> d.sentiment==='Negative').length;
  const negPct = total ? ((negatives/total)*100).toFixed(1)+'%' : '0%';
  document.getElementById('kpiTotal').textContent = total;
  document.getElementById('kpiNegative').textContent = negPct;

  // Best & worst stores â€” use weighted score (avg_rating * log(1 + review_count))
  const byStore = {};
  state.data.forEach(r=>{
    const s = r.storeCode || 'UNKNOWN';
    if(!byStore[s]) byStore[s] = {sum:0,count:0};
    byStore[s].sum += Number(r.rating||0);
    byStore[s].count++;
  });
  const arr = Object.entries(byStore).map(([k,v]) => {
    const avg = v.count ? (v.sum / v.count) : 0;
    const weighted = avg * Math.log(1 + v.count);
    return {store:k, avg, count:v.count, weighted};
  }).filter(x=>x.store);

  arr.sort((a,b)=> b.weighted - a.weighted);
  const best = arr[0];
  if(best){
    document.getElementById('kpiBest').textContent = `${best.store} (${best.avg.toFixed(2)} / ${best.count})`;
  } else document.getElementById('kpiBest').textContent = 'â€”';

  // worst by avg rating (simple)
  const worstArr = arr.slice().sort((a,b)=> a.avg - b.avg);
  const worst = worstArr[0];
  if(worst) document.getElementById('kpiWorst').textContent = `${worst.store} (${worst.avg.toFixed(2)} / ${worst.count})`;
  else document.getElementById('kpiWorst').textContent = 'â€”';
}

function generateStrategicInsights(){
  const data = state.data;
  // theme counts
  const cats = {};
  data.forEach(r=>{
    const c = classifyImprovementCategory(r.comment);
    if(c==='Miscellaneous') return;
    cats[c] = (cats[c]||0) + 1;
  });
  const totalCats = Object.values(cats).reduce((a,b)=>a+b,0) || 1;
  const sortedCats = Object.entries(cats).map(([k,v])=>({k,v, pct: v/totalCats*100})).sort((a,b)=>b.v-a.v);
  const topTheme = sortedCats[0] ? sortedCats[0].k : 'Store Experience';
  const topPct = sortedCats[0] ? Math.round(sortedCats[0].pct) : 0;

  // zone stats
  const zoneMap = {};
  data.forEach(r=>{
    if(!zoneMap[r.zone]) zoneMap[r.zone] = {sum:0,count:0,neg:0};
    zoneMap[r.zone].sum += r.rating; zoneMap[r.zone].count++;
    if(r.sentiment==='Negative') zoneMap[r.zone].neg++;
  });
  const zones = Object.entries(zoneMap).map(([z,v])=>({z,avg: v.count? v.sum/v.count:0, negPct: v.count? v.neg/v.count*100:0})).sort((a,b)=>b.negPct-a.negPct);
  const topZone = zones[0] || {z:'N/A', avg:0};

  const storeMap = {};
  data.forEach(r=>{
    if(!storeMap[r.storeCode]) storeMap[r.storeCode] = {sum:0,count:0,neg:0};
    storeMap[r.storeCode].sum += r.rating; storeMap[r.storeCode].count++;
    if(r.sentiment==='Negative') storeMap[r.storeCode].neg++;
  });
  const underperformers = Object.entries(storeMap).map(([s,v])=>({s, avg: v.count? v.sum/v.count:0, count:v.count, negPct: v.count? v.neg/v.count*100:0})).filter(x=>x.avg <= 4).sort((a,b)=>a.avg-b.avg).slice(0,5).map(x=>x.s).join(', ') || 'N/A';

  // positive momentum: compare last 30 days vs previous 30 days
  const today = new Date();
  function daysAgo(n){ const d = new Date(); d.setDate(d.getDate() - n); return d; }
  const last30 = data.filter(r=> new Date(r.commentDate) >= daysAgo(30));
  const prev30 = data.filter(r=> new Date(r.commentDate) >= daysAgo(60) && new Date(r.commentDate) < daysAgo(30));
  const posLast = last30.filter(r=> r.sentiment==='Positive').length;
  const posPrev = prev30.filter(r=> r.sentiment==='Positive').length;
  const posPctChange = posPrev ? Math.round((posLast - posPrev)/posPrev * 100) : (posLast ? 100 : 0);

  // top cities
  const cityCounts = {};
  data.forEach(r=> cityCounts[r.city] = (cityCounts[r.city]||0)+1);
  const topCities = Object.entries(cityCounts).map(([c,v])=>({c,v})).sort((a,b)=>b.v-a.v).slice(0,3).map(x=>x.c).join(', ') || 'N/A';

  // leading store
  const bestByAvg = Object.entries(storeMap).map(([s,v])=>({s,avg:v.count? v.sum/v.count:0})).sort((a,b)=>b.avg-a.avg)[0];
  const bestText = bestByAvg ? `${bestByAvg.s} (${bestByAvg.avg.toFixed(1)})` : 'N/A';

  return [
    {headline:'Store Experience Dominates', description:`${topTheme} is the most mentioned theme (â‰ˆ${topPct}%). It drives both praise and criticism.`},
    {headline:`${topZone.z} Zone Sentiment Dip`, description:`Average rating down to ${topZone.avg.toFixed(1)} driven by negative in-store experiences.`},
    {headline:'Stores needing Urgent Attention', description:`These stores have low avg ratings and rising negative sentiment: ${underperformers}`},
    {headline:'Uptick in Positive Feedback', description:`Positive reviews changed ${posPctChange}% comparing most recent 30 days to previous window.`},
    {headline:`Top Cities: ${topCities}`, description:`These cities generate the most feedback; focus improvement efforts here.`},
    {headline:'Leading Store Performance', description:`Top performing store by average: ${bestText}`},
  ];
}

/* ========= Renderers ========= */

function renderInsights(){
  const grid = document.getElementById('insightsGrid'); grid.innerHTML = '';
  const items = generateStrategicInsights();
  items.forEach(it=>{
    const el = document.createElement('div'); el.className='insight-card';
    el.innerHTML = `<h4>${escapeHtml(it.headline)}</h4><p style="color:var(--muted)">${escapeHtml(it.description)}</p>`;
    grid.appendChild(el);
  });
}

function renderDrivers(){
  const counts = {};
  state.data.forEach(r=>{
    const cat = classifyImprovementCategory(r.comment);
    counts[cat] = (counts[cat]||0) + 1;
  });
  const arr = Object.entries(counts).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
  // keep only top 10 or all
  const top = arr.slice(0,10);
  // pills
  const pillWrap = document.getElementById('driverPills'); pillWrap.innerHTML = '';
  top.forEach(item=>{
    const d = document.createElement('div'); d.className='pill'; d.textContent = `${item.k} (${item.v})`; pillWrap.appendChild(d);
  });

  const list = document.getElementById('driversList'); list.innerHTML='';
  const max = Math.max(...top.map(t=>t.v), 1);
  top.forEach(it=>{
    const row = document.createElement('div'); row.className='drivers-row';
    const label = document.createElement('div'); label.className='drivers-label'; label.textContent = it.k;
    const barWrap = document.createElement('div'); barWrap.className='drivers-bar';
    barWrap.style.background = 'linear-gradient(90deg, rgba(16,185,129,0.18), rgba(16,185,129,0.08))';
    const pct = Math.round(it.v / max * 100);
    barWrap.style.position = 'relative';
    const inner = document.createElement('div'); inner.style.width = pct + '%'; inner.style.height='100%'; inner.style.background = 'rgba(16,185,129,0.9)'; inner.style.borderRadius='10px';
    barWrap.appendChild(inner);
    const val = document.createElement('span'); val.textContent = it.v;
    barWrap.appendChild(val);
    row.appendChild(label); row.appendChild(barWrap);
    list.appendChild(row);
  });

  // snapshot for right column
  const sn = document.getElementById('driverSnapshot'); sn.textContent = top.slice(0,3).map(x=>`${x.k} (${x.v})`).join(' â€¢ ');
}

function renderSentimentPie(){
  const counts = {Positive:0,Neutral:0,Negative:0};
  state.data.forEach(d=> counts[d.sentiment] = (counts[d.sentiment]||0) + 1);
  const total = counts.Positive + counts.Neutral + counts.Negative || 1;

  // svg pie
  const size = 220; const cx = size/2, cy=size/2, r = size/2 - 8;
  const svgNS = 'http://www.w3.org/2000/svg';
  const pie = document.getElementById('pieChart'); pie.innerHTML='';
  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('width',size); svg.setAttribute('height',size); svg.setAttribute('viewBox',`0 0 ${size} ${size}`);
  let start = -Math.PI/2;
  Object.entries(counts).forEach(([k,v])=>{
    const slice = (v/total) * Math.PI * 2;
    const end = start + slice;
    const x1 = cx + r * Math.cos(start), y1 = cy + r * Math.sin(start);
    const x2 = cx + r * Math.cos(end), y2 = cy + r * Math.sin(end);
    const large = slice > Math.PI ? 1 : 0;
    const path = document.createElementNS(svgNS,'path');
    const d = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z`;
    path.setAttribute('d', d);
    path.setAttribute('fill', SENT_COLORS[k]);
    svg.appendChild(path);

    start = end;
  });
  pie.appendChild(svg);

  const legend = document.getElementById('pieLegend'); legend.innerHTML='';
  Object.entries(counts).forEach(([k,v])=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px';
    const sw = document.createElement('div'); sw.style.width='12px'; sw.style.height='12px'; sw.style.borderRadius='4px'; sw.style.background = SENT_COLORS[k];
    const label = document.createElement('div'); label.innerHTML = `<b style="color:var(--blue)">${k}</b> â€” ${(v/total*100).toFixed(1)}% (${v})`;
    row.appendChild(sw); row.appendChild(label); legend.appendChild(row);
  });
}

function renderWordCloud(){
  const counts = {};
  state.data.forEach(r=>{
    detectEmotions(r.comment).forEach(e=> counts[e] = (counts[e]||0) + 1);
  });
  const wc = document.getElementById('wordCloud'); wc.innerHTML='';
  const total = Object.values(counts).reduce((a,b)=>a+b,0) || 1;
  const palette = ['#2dd4bf','#34d399','#10b981','#059669','#f59e0b','#ef4444','#ef9a9a'];
  let idx=0;
  Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([word,c])=>{
    const el = document.createElement('div'); el.className='chip';
    el.style.background = palette[idx % palette.length];
    el.style.color = '#fff';
    el.style.fontSize = (12 + Math.round((c/total) * 18)) + 'px';
    el.textContent = `${word} (${c})`;
    wc.appendChild(el);
    idx++;
  });
}

function renderLineChart(){
  // static APR, MAY, JUN counts (counts per sentiment)
  const months = MONTH_ORDER;
  const counts = months.map(m=>{
    return {
      m,
      Positive: state.raw.filter(r=> r.month === m && r.sentiment === 'Positive').length,
      Negative: state.raw.filter(r=> r.month === m && r.sentiment === 'Negative').length,
      Neutral: state.raw.filter(r=> r.month === m && r.sentiment === 'Neutral').length
    };
  });

  const container = document.getElementById('lineChart'); container.innerHTML='';
  const width = container.clientWidth || 520, height = 240, padding = 40;
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('width','100%'); svg.setAttribute('height',height); svg.setAttribute('viewBox',`0 0 ${width} ${height}`);

  const getMax = Math.max(...counts.map(c=> Math.max(c.Positive,c.Negative,c.Neutral)), 1);
  const xScale = (i) => padding + i * ((width - padding*2) / (months.length - 1));
  const yScale = (v) => padding + ( (1 - (v / getMax)) * (height - padding*2) );

  // grid lines
  for(let i=0;i<=4;i++){
    const y = padding + i * ((height - padding*2)/4);
    const line = document.createElementNS(svgNS,'line');
    line.setAttribute('x1', padding); line.setAttribute('x2', width - padding);
    line.setAttribute('y1', y); line.setAttribute('y2', y); line.setAttribute('stroke','rgba(2,6,23,0.06)');
    svg.appendChild(line);
  }

  // helper draw line function
  function drawLine(values, color){
    const pathD = values.map((v,i)=> `${i===0?'M':'L'} ${xScale(i)} ${yScale(v)}`).join(' ');
    const path = document.createElementNS(svgNS,'path'); path.setAttribute('d', pathD); path.setAttribute('fill','none'); path.setAttribute('stroke', color); path.setAttribute('stroke-width','2'); svg.appendChild(path);
    values.forEach((v,i)=>{
      const cx = xScale(i), cy = yScale(v);
      const circle = document.createElementNS(svgNS,'circle'); circle.setAttribute('cx',cx); circle.setAttribute('cy',cy); circle.setAttribute('r',5); circle.setAttribute('fill','#fff'); circle.setAttribute('stroke', color); circle.setAttribute('stroke-width',2);
      circle.style.cursor='pointer';
      // tooltip on click/hover: detailed counts
      circle.addEventListener('mouseenter', (e)=>{
        showLineTooltip(e.clientX, e.clientY, months[i], counts[i]);
      });
      circle.addEventListener('mouseleave', hideLineTooltip);
      svg.appendChild(circle);
    });
  }

  drawLine(counts.map(c=>c.Positive), SENT_COLORS.Positive);
  drawLine(counts.map(c=>c.Negative), SENT_COLORS.Negative);
  drawLine(counts.map(c=>c.Neutral), SENT_COLORS.Neutral);

  // month labels
  months.forEach((m,i)=>{
    const tx = document.createElementNS(svgNS,'text'); tx.setAttribute('x', xScale(i)); tx.setAttribute('y', height - 6); tx.setAttribute('font-size','12'); tx.setAttribute('text-anchor','middle'); tx.textContent = m; svg.appendChild(tx);
  });

  container.appendChild(svg);

  // tooltip (single element)
  let tt;
  function showLineTooltip(x,y,month,counts){
    hideLineTooltip();
    tt = document.createElement('div');
    tt.style.position='fixed'; tt.style.left=(x+8)+'px'; tt.style.top=(y+8)+'px';
    tt.style.background='#fff'; tt.style.padding='10px'; tt.style.border='1px solid rgba(2,6,23,0.08)'; tt.style.borderRadius='8px'; tt.style.boxShadow='0 8px 30px rgba(2,6,23,0.08)';
    tt.innerHTML = `<div style="font-weight:700">${month}</div>
                    <div style="color:${SENT_COLORS.Positive}; margin-top:6px">POSITIVE : ${counts.Positive}</div>
                    <div style="color:${SENT_COLORS.Negative}; margin-top:4px">NEGATIVE : ${counts.Negative}</div>
                    <div style="color:${SENT_COLORS.Neutral}; margin-top:4px">NEUTRAL : ${counts.Neutral}</div>`;
    document.body.appendChild(tt);
  }
  function hideLineTooltip(){ if(tt){ tt.remove(); tt=null; } }
}

function renderHeatmap(){
  // build storeCat from entire raw dataset (this is a heatmap summary, unaffected by filters)
  const storeCat = {};
  state.raw.forEach(r=>{
    const cat = classifyImprovementCategory(r.comment);
    if(cat==='Miscellaneous') return;
    if(!storeCat[r.storeCode]) storeCat[r.storeCode] = {};
    if(!storeCat[r.storeCode][cat]) storeCat[r.storeCode][cat] = {score:0,count:0};
    storeCat[r.storeCode][cat].score += sentimentScore(r.sentiment);
    storeCat[r.storeCode][cat].count++;
  });

  const storeCounts = {};
  state.raw.forEach(r=> storeCounts[r.storeCode] = (storeCounts[r.storeCode]||0) + 1);
  const topStores = Object.entries(storeCounts).map(([s,c])=>({s,c})).sort((a,b)=>b.c-a.c).slice(0,10).map(x=>x.s);
  const categories = uniq([].concat(...Object.values(storeCat).map(s=>Object.keys(s))));

  const table = document.getElementById('heatmapTable'); table.innerHTML='';
  const thead = document.createElement('thead'); const trh = document.createElement('tr');
  trh.innerHTML = `<th>Store / Category</th>` + categories.map(cat=>`<th>${escapeHtml(cat)}</th>`).join('');
  thead.appendChild(trh); table.appendChild(thead);

  const tbody = document.createElement('tbody');
  topStores.forEach(store=>{
    const tr = document.createElement('tr'); let tds = `<th>${escapeHtml(store)}</th>`;
    categories.forEach(cat=>{
      const stat = storeCat[store] && storeCat[store][cat] ? storeCat[store][cat] : {score:0,count:0};
      const avg = stat.count ? stat.score / stat.count : 0;
      const display = stat.count ? (avg.toFixed(2) + ' (' + stat.count + ')') : '-';
      const bg = avg > 0 ? `rgba(16,185,129,${Math.min(0.9, Math.abs(avg))})` : avg < 0 ? `rgba(239,68,68,${Math.min(0.9, Math.abs(avg))})` : `rgba(245,158,11,0.08)`;
      tds += `<td style="background:${bg}">${display}</td>`;
    });
    tr.innerHTML = tds;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
}

function renderZoneChart(){
  const zoneMap = {};
  state.data.forEach(r=>{
    if(!zoneMap[r.zone]) zoneMap[r.zone] = {sum:0,count:0};
    zoneMap[r.zone].sum += sentimentScore(r.sentiment);
    zoneMap[r.zone].count++;
  });
  const arr = Object.entries(zoneMap).map(([z,v])=>({z,avg: v.count? v.sum/v.count:0, count:v.count})).sort((a,b)=>b.avg-a.avg);

  const container = document.getElementById('zoneChart'); container.innerHTML='';
  const width = container.clientWidth || 380, height = 220, padding = 30;
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('width','100%'); svg.setAttribute('height',height); svg.setAttribute('viewBox',`0 0 ${width} ${height}`);
  const max = Math.max(...arr.map(a=> Math.abs(a.avg)), 1);

  arr.forEach((a,i)=>{
    const bw = (width - padding*2) / Math.max(1,arr.length);
    const barH = ((a.avg + 1)/2) * (height - padding*2);
    const x = padding + i * bw + 6;
    const y = height - padding - barH;
    const rect = document.createElementNS(svgNS,'rect');
    rect.setAttribute('x', x); rect.setAttribute('y', y); rect.setAttribute('width', Math.max(10,bw-12)); rect.setAttribute('height', barH); rect.setAttribute('rx',8);
    rect.setAttribute('fill', a.avg > 0 ? SENT_COLORS.Positive : (a.avg < 0 ? SENT_COLORS.Negative : SENT_COLORS.Neutral));
    svg.appendChild(rect);
    const label = document.createElementNS(svgNS,'text'); label.setAttribute('x', x + (Math.max(10,bw-12)/2)); label.setAttribute('y', height - 8); label.setAttribute('font-size','12'); label.setAttribute('text-anchor','middle'); label.textContent = a.z;
    svg.appendChild(label);
  });

  container.appendChild(svg);
}

function renderTopStoresList(){
  const storeCounts = {};
  state.raw.forEach(r=> storeCounts[r.storeCode] = (storeCounts[r.storeCode]||0) + 1);
  const arr = Object.entries(storeCounts).map(([s,c])=>({s,c})).sort((a,b)=>b.c-a.c).slice(0,30);
  const wrap = document.getElementById('topStoresList'); wrap.innerHTML='';
  arr.forEach(item=>{
    const el = document.createElement('div'); el.style.padding='8px 6px'; el.style.borderBottom='1px solid rgba(2,6,23,0.04)';
    el.innerHTML = `<div style="font-weight:700">${escapeHtml(item.s)}</div><div style="color:var(--muted);font-size:13px">${item.c} reviews</div>`;
    wrap.appendChild(el);
  });
}

/* comments */
function renderComments(){
  const data = state.data.map(r=> ({...r, parsedDate: new Date(r.commentDate)})).sort((a,b)=> b.parsedDate - a.parsedDate);
  const positives = data.filter(r=> r.sentiment==='Positive').slice(0,15);
  const negatives = data.filter(r=> r.sentiment==='Negative').slice(0,15);

  const posWrap = document.getElementById('positiveComments'); posWrap.innerHTML='';
  positives.forEach(r=>{
    const card = document.createElement('div'); card.className='comment-card';
    card.innerHTML = `<div style="font-size:14px"><b>${escapeHtml(r.comment)}</b></div><div style="font-size:12px;color:var(--muted);margin-top:6px">Store: ${escapeHtml(r.storeCode)} | Date: ${formatDateYMD(r.commentDate)}</div>`;
    posWrap.appendChild(card);
  });

  const negWrap = document.getElementById('negativeComments'); negWrap.innerHTML='';
  negatives.forEach(r=>{
    const card = document.createElement('div'); card.className='comment-card';
    card.innerHTML = `<div style="font-size:14px"><b>${escapeHtml(r.comment)}</b></div><div style="font-size:12px;color:var(--muted);margin-top:6px">Store: ${escapeHtml(r.storeCode)} | Date: ${formatDateYMD(r.commentDate)}</div>`;
    negWrap.appendChild(card);
  });
}

/* ========= CSV download ========= */
function downloadFilteredCSV(){
  if(!state.data.length){ alert('No data to download'); return; }
  const cols = ['storeCode','businessName','zone','state','city','mallType','fy','quarter','month','rating','sentiment','commentDate','comment'];
  const lines = state.data.map(r => cols.map(c => `"${String(r[c]===undefined?'':r[c]).replace(/"/g,'""')}"`).join(','));
  const csv = [cols.join(',')].concat(lines).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='voc_filtered.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ========= Initialization & render orchestration ========= */
function initDefaults(){
  // set default business if available
  if(state.derived.businessNames.length) state.filters.businessName = state.derived.businessNames[0];
  // by default no sentiments/zones selected
}

function renderAll(){
  applyFilters();
  computeKPIs();
  renderInsights();
  renderDrivers();
  renderSentimentPie();
  renderWordCloud();
  renderLineChart();
  renderHeatmap();
  renderZoneChart();
  renderTopStoresList();
  renderComments();
  buildFiltersUI();
}

/* ========= Event wiring ========= */
document.getElementById('openFilters').addEventListener('click', openFilters);
document.getElementById('closeFilters').addEventListener('click', closeFilters);
document.getElementById('applyFilters').addEventListener('click', ()=>{
  applyFilters();
  renderAll();
  closeFilters();
});
document.getElementById('applyBtn').addEventListener('click', ()=>{
  applyFilters();
  renderAll();
  closeFilters();
});
document.getElementById('resetBtn').addEventListener('click', ()=>{
  state.filters = { businessName: null, zones: new Set(), states: new Set(), cities: new Set(), sentiments: new Set() };
  buildFiltersUI();
});
document.getElementById('resetFiltersBtn').addEventListener('click', ()=>{
  state.filters = { businessName: null, zones: new Set(), states: new Set(), cities: new Set(), sentiments: new Set() };
  renderAll();
});
document.getElementById('downloadCsvBtn').addEventListener('click', downloadFilteredCSV);

/* Collapsible sections behaviour inside modal */
document.addEventListener('click', (e)=>{
  if(e.target.closest('.collapsible .heading')){
    const heading = e.target.closest('.collapsible .heading');
    const collapsible = heading.parentElement;
    const body = collapsible.querySelector('.body');
    const isOpen = body.style.display === 'block';
    document.querySelectorAll('.collapsible .body').forEach(b=> b.style.display = 'none');
    if(!isOpen) body.style.display = 'block';
  }
});

/* ========= Start ========= */
loadData();

</script>
</body>
</html>
