<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voice of Customer — Google Reviews Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<!-- External libs for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#e5e7eb;
  --positive:#10b981;
  --negative:#ef4444;
  --neutral:#f59e0b;
  --blue:#1e3a8a;
  --card:#f8fafc;
  --muted:#6b7280;
  --glass: rgba(255,255,255,0.6);
  --shadow: 0 6px 18px rgba(15,23,42,0.06);
  font-family: Roboto, system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial;
}

/* Theme options remain unchanged */
.theme-ocean {
  --bg:#e8f9ff;
  --positive:#16a085;
  --negative:#d64545;
  --neutral:#f39c12;
  --blue:#0b6fa4;
  --card:#ffffff;
  --muted:#3b4b58;
}
.theme-dark {
  --bg:#0b1220;
  --positive:#2ecc71;
  --negative:#e74c3c;
  --neutral:#f39c12;
  --blue:#60a5fa;
  --card:#0f1724;
  --muted:#94a3b8;
}
.theme-warm {
  --bg:#fff5eb;
  --positive:#0ea5a1;
  --negative:#ef4444;
  --neutral:#f59e0b;
  --blue:#b45309;
  --card:#fffdf9;
  --muted:#6b4f3b;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:#0f172a;
  padding:12px;
  font-size:14px;
}

/* --- LAYOUT FIXES --- */
.app { 
  display:flex; 
  gap:16px; 
  align-items:stretch; 
  height:calc(100vh - 24px); 
}

/* Filter Panel */
.filter-panel{
  width:320px;
  background:linear-gradient(180deg,#ffffff,#fbfdff);
  border-radius:12px;
  padding:16px;
  box-shadow:var(--shadow);
  overflow:auto;
}
.filter-panel.hidden{display:none}

/* Main area centered */
.main { 
  flex:1; 
  display:flex; 
  flex-direction:column; 
  gap:12px; 
  max-width:1600px;
  margin:0 auto;
}

/* --- CENTERED TOPBAR FIX --- */
.topbar{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  gap:4px;
  width:100%;
  margin-bottom:8px;
}

.kpis {
  display:flex;
  gap:12px;
  justify-content:center;
  align-items:center;
  flex-wrap:wrap;
  width:100%;
}

.kpi {
  background:var(--card);
  padding:12px 16px;
  border-radius:10px;
  min-width:160px;
  text-align:center;
  box-shadow:var(--shadow);
}

.kpi .label{color:var(--muted); font-size:12px}
.kpi .value{font-size:20px; font-weight:700}

/* Insights Grid */
.insights {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:12px;
}

/* Cards remain unchanged */
.card{
  background:#fff;
  border-radius:10px;
  padding:12px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.card h3{margin:0 0 8px 0; color:var(--blue); font-size:15px}
/* Pills */
.pills {display:flex; gap:8px; flex-wrap:wrap}
.pill {
  padding:6px 10px;
  border-radius:999px;
  background:#f1f5f9;
  font-size:12px;
  font-weight:500;
  cursor:pointer;
}

/* Word Cloud */
.word-cloud{
  min-height:180px;
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:8px;
}

/* SVG container */
.svg-chart{
  width:100%;
  height:220px;
}

/* Heatmap */
.heatmap-wrap{
  overflow:auto;
  border-radius:8px;
  padding:8px;
  background:linear-gradient(180deg,#ffffff,#fbfdff);
}
.heatmap-table{
  border-collapse:collapse;
  min-width:100%;
}
.heatmap-table th, .heatmap-table td{
  padding:8px 10px;
  border:1px solid rgba(15,23,42,0.06);
  white-space:nowrap;
}
.heatmap-table th{
  position:sticky;
  top:0;
  background:#fff;
  z-index:2;
}

/* Comments Panel */
.comments-row{
  display:flex;
  gap:12px;
}
.comment-column{
  flex:1;
  background:#fff;
  border-radius:10px;
  padding:12px;
  box-shadow:var(--shadow);
  max-height:420px;
  overflow:auto;
}
.comment-card{
  background:#f8fafc;
  border-radius:8px;
  border:1px solid rgba(2,6,23,0.04);
  padding:10px;
  margin-bottom:8px;
}
.comment-card b{
  display:block;
}
.comment-meta{
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
}

/* Buttons */
.btn{
  padding:8px 10px;
  background:#fff;
  border-radius:8px;
  border:1px solid rgba(2,6,23,0.06);
  cursor:pointer;
}
.btn.primary{
  background:var(--blue);
  color:white;
  border:none;
}
.small{font-size:13px; padding:6px 8px}

/* Modal */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal{
  background:var(--card);
  border-radius:10px;
  padding:16px;
  width:760px;
  max-height:80vh;
  overflow:auto;
  box-shadow:var(--shadow);
}

/* Responsive Fixes */
@media (max-width:1100px){
  .filter-panel{display:none}
  .grid, .row-2, .row-3 {grid-template-columns:1fr}
}
</style>
</head>

<body>
<div class="app" id="appRoot">

  <!-- FILTER PANEL (left) -->
  <aside class="filter-panel" id="filterPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h2 style="margin:0;font-size:16px;color:var(--blue)">Filters</h2>
      <button class="btn small" id="hideFilterBtn">Hide</button>
    </div>

    <!-- BUSINESS NAME -->
    <div class="label-muted">Business Name</div>
    <div id="businessNameWrap"></div>

    <hr style="margin:12px 0;border:none;border-top:1px solid rgba(2,6,23,0.06)">

    <!-- ZONE -->
    <div class="label-muted">Zone</div>
    <div id="zoneWrap"></div>

    <!-- STATE -->
    <div class="label-muted" style="margin-top:8px">
      State
      <input placeholder="Search state..." id="stateSearch" class="search-input" />
    </div>
    <div id="stateWrap"></div>

    <!-- CITY -->
    <div class="label-muted" style="margin-top:8px">
      City
      <input placeholder="Search city..." id="citySearch" class="search-input" />
    </div>
    <div id="cityWrap"></div>

    <!-- STORE -->
    <div class="label-muted" style="margin-top:8px">
      Store
      <input placeholder="Search store..." id="storeSearch" class="search-input" />
    </div>
    <div id="storeWrap"></div>

    <!-- Mall Type -->
    <div class="label-muted" style="margin-top:8px">Mall Type</div>
    <div id="mallWrap"></div>

    <!-- Sentiment -->
    <div class="label-muted" style="margin-top:8px">Sentiment</div>
    <div id="sentimentWrap"></div>

    <!-- FY -->
    <div class="label-muted" style="margin-top:8px">Financial Year</div>
    <div id="fyWrap"></div>

    <!-- Quarter -->
    <div class="label-muted" style="margin-top:8px">Quarter</div>
    <div id="quarterWrap"></div>

    <!-- Month -->
    <div class="label-muted" style="margin-top:8px">Month</div>
    <div id="monthWrap"></div>

    <div style="margin-top:12px;display:flex;gap:8px;justify-content:space-between">
      <button class="btn primary" id="applyFilters">Apply</button>
      <button class="btn" id="resetFilters">Reset</button>
    </div>

  </aside>

  <!-- MAIN CONTENT (center aligned) -->
  <main class="main">

    <!-- TOP BAR (centered heading + KPIs) -->
    <div class="topbar">
      <div style="font-size:22px;font-weight:700">Voice of Customer — Google Reviews</div>
      <div style="font-size:14px;color:var(--muted);margin-top:-2px">Interactive Analytics Dashboard</div>

      <!-- KPI ROW -->
      <div class="kpis">
        <div class="kpi">
          <div class="label">Total Reviews</div>
          <div class="value" id="kpiTotal">0</div>
        </div>

        <div class="kpi">
          <div class="label">% Negative Reviews</div>
          <div class="value" id="kpiNegative">0%</div>
        </div>

        <div class="kpi">
          <div class="label">Best Store</div>
          <div class="value" id="kpiBest">—</div>
        </div>

        <div class="kpi">
          <div class="label">Worst Store</div>
          <div class="value" id="kpiWorst">—</div>
        </div>
      </div>

      <!-- Theme / Download buttons -->
      <div style="margin-top:10px;display:flex;gap:8px;">
        <select id="themeSelect" class="btn small">
          <option value="">Light</option>
          <option value="theme-dark">Dark</option>
          <option value="theme-ocean">Ocean</option>
          <option value="theme-warm">Warm</option>
        </select>

        <button id="downloadCsvBtn" class="btn small">Download CSV</button>
        <button id="exportPdfBtn" class="btn small">Export PDF</button>
      </div>
    </div>

    <!-- INSIGHTS GRID -->
    <div id="insightsGrid" class="insights"></div>

    <!-- ROW 1 -->
    <div class="grid">
      <div class="card">
        <h3>Key Drivers of Customer Feedback</h3>
        <div id="driverPills" class="pills"></div>
        <div id="driversChart" class="svg-chart"></div>
      </div>

      <div class="card">
        <h3>Sentiment Distribution</h3>
        <div id="sentimentPie" style="display:flex;gap:12px;align-items:center">
          <div id="pieChart" style="width:180px;height:180px"></div>
          <div id="pieLegend" style="flex:1"></div>
        </div>
      </div>
    </div>

    <!-- ROW 2 -->
    <div class="row-2">
      <div class="card">
        <h3>Emotion Word Cloud</h3>
        <div id="wordCloud" class="word-cloud"></div>
      </div>

      <div class="card">
        <h3>Sentiment Trend Over Time (APR → MAR)</h3>
        <div id="lineChart" class="svg-chart"></div>
      </div>
    </div>

    <!-- Continue... -->
    <!-- ROW 3 -->
    <div class="row-3">
      <div class="card">
        <h3>Store Sentiment Heatmap (Top 10 Stores × Categories)</h3>
        <div id="heatmapWrap" class="heatmap-wrap" style="margin-top:8px">
          <table id="heatmapTable" class="heatmap-table"></table>
        </div>
      </div>

      <div class="card">
        <h3>Sentiment by Zone</h3>
        <div id="zoneChart" class="svg-chart"></div>
      </div>
    </div>

    <!-- COMMENTS ROW -->
    <div class="comments-row" style="margin-top:8px">
      <div class="comment-column">
        <h3 style="color:var(--blue);margin-bottom:10px">Positive Comments (Top 15)</h3>
        <div id="positiveComments"></div>
      </div>

      <div class="comment-column">
        <h3 style="color:var(--blue);margin-bottom:10px">Negative Comments (Top 15)</h3>
        <div id="negativeComments"></div>
      </div>
    </div>

  </main>
</div>

<!-- DRILL DOWN MODAL -->
<div id="modalBackdrop" class="modal-backdrop">
  <div id="drillModal" class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="modalTitle">Store Details</h3>
      <button class="btn" id="closeModal">Close</button>
    </div>
    <div id="modalBody" style="margin-top:12px"></div>
  </div>
</div>

<!-- =========================
       CORE JAVASCRIPT
========================= -->
<script>
/* API fallback sources */
const API_URLS = [
  "https://raw.githubusercontent.com/Harishbose/voc-dashboard/main/reviews.json"
];

const MONTH_ORDER = ["APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC","JAN","FEB","MAR"];
const SENTIMENT_COLORS = {
  Positive: "#10b981",
  Neutral: "#f59e0b",
  Negative: "#ef4444"
};

let state = {
  rawData: [],
  data: [],
  filters: {
    businessName: null,
    zones: new Set(),
    states: new Set(),
    cities: new Set(),
    stores: new Set(),
    mallTypes: new Set(),
    sentiments: new Set(),
    fys: new Set(),
    quarters: new Set(),
    months: new Set()
  },
  derived: {}
};

/* Escape HTML */
function escapeHtml(s){
  return String(s || "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");
}

/* Sentiment → numeric score */
function sentimentScore(s){
  if(s==="Positive") return 1;
  if(s==="Negative") return -1;
  return 0;
}

/* Emotion detection (simple heuristic) */
function detectEmotions(text){
  if(!text) return [];
  const t = text.toLowerCase();
  let out = [];
  if(/thank|appreciat|love/.test(t)) out.push("Gratitude");
  if(/angry|hate|terrible|worst/.test(t)) out.push("Frustration");
  if(/happy|great|excellent|satisfied/.test(t)) out.push("Satisfaction");
  if(/disappointed|sad|upset/.test(t)) out.push("Disappointment");
  if(/confused|unclear|unsure/.test(t)) out.push("Confusion");
  return out;
}

/* Identify improvement category (simple NLP) */
function classifyImprovementCategory(text){
  if(!text) return "Miscellaneous";
  const t = text.toLowerCase();
  const match = words => words.some(w => t.includes(w));

  if(match(["staff","service","salesman","experience"])) return "Store Experience";
  if(match(["quality","material","defect","faulty"])) return "Product Quality";
  if(match(["collection","variety","stock","availability"])) return "Inventory Management";
  if(match(["price","expensive","discount"])) return "Pricing & Discounts";
  if(match(["return","exchange","refund"])) return "Return Policies";
  if(match(["help","support","query","resolution"])) return "Customer Support";
  if(match(["promotion","offer","coupon"])) return "Promotions";
  if(match(["billing","payment","charge"])) return "Billing Issues";
  if(match(["behaviour","rude","attitude"])) return "Staff Behaviour";
  if(match(["wait","queue","delay"])) return "Queue Management";

  return "Miscellaneous";
}

/* Identify date format */
function looksLikeDate(s){
  if(!s) return false;
  return /^\d{4}-\d{2}-\d{2}/.test(s) ||
         /^\d{2}\/\d{2}\/\d{4}/.test(s);
}

function formatDateYMD(str){
  const d = new Date(str);
  if(isNaN(d)) return str;
  return (d.getMonth()+1).toString().padStart(2,"0") + "/" +
         d.getDate().toString().padStart(2,"0") + "/" +
         d.getFullYear();
}

/* =========================
   LOAD JSON DATA
========================= */
async function loadReviewData(){
  for(const url of API_URLS){
    try{
      console.log("Trying:", url);
      const res = await fetch(url);
      if(!res.ok) continue;
      const json = await res.json();
      if(Array.isArray(json) && json.length > 0){
        console.log("Loaded:", json.length, "records");
        return json;
      }
    } catch(e){
      console.warn("Failed:", url, e);
    }
  }
  alert("Could not load review data.");
  return [];
}

/* =========================
   NORMALIZE RECORD
========================= */
function normalizeRecord(r){
  let rec = {};

  rec.rating = Number(r.rating || r["Google Rating"] || 0);
  rec.storeCode = r.storeCode || r["Store Name"] || "";
  rec.mallType = r.mallType || r["Mall/HS"] || "";
  rec.businessName = r.businessName || r["Brand"] || "";
  rec.zone = r.zone || "";
  rec.state = r.state || "";
  rec.city = r.city || "";

  rec.commentDate = r.commentDate || r["Comment Date"] || "";
  rec.month = (r.month || "").toString().toUpperCase();
  rec.quarter = r.quarter || "";
  rec.fy = r.fy || r["Financial Year"] || "";

  rec.sentiment = r.sentiment || "Neutral";

  // comment extraction
  rec.comment =
    r.comment ||
    r["Customer Response"] ||
    r.responseType ||
    "";

  rec.__raw = r;
  return rec;
}

/* Build distinct dropdown lists */
function refreshDerivedLists(all){
  const get = key => [...new Set(all.map(r => r[key] || ""))].filter(x => x);

  state.derived.businessNames = get("businessName").sort();
  state.derived.zones = get("zone").sort();
  state.derived.states = get("state").sort();
  state.derived.cities = get("city").sort();
  state.derived.stores = get("storeCode").sort();
  state.derived.mallTypes = get("mallType").sort();
  state.derived.fys = get("fy").sort().reverse();
  state.derived.quarters = get("quarter").sort();
  state.derived.months = get("month").sort(
    (a,b)=> MONTH_ORDER.indexOf(a)-MONTH_ORDER.indexOf(b)
  );
}
/* =========================
   APPLY FILTERS
========================= */
function applyFilters(){
  let d = [...state.rawData];
  const f = state.filters;

  if(f.businessName) d = d.filter(r => r.businessName === f.businessName);
  if(f.zones.size) d = d.filter(r => f.zones.has(r.zone));
  if(f.states.size) d = d.filter(r => f.states.has(r.state));
  if(f.cities.size) d = d.filter(r => f.cities.has(r.city));
  if(f.stores.size) d = d.filter(r => f.stores.has(r.storeCode));
  if(f.mallTypes.size) d = d.filter(r => f.mallTypes.has(r.mallType));
  if(f.sentiments.size) d = d.filter(r => f.sentiments.has(r.sentiment));
  if(f.fys.size) d = d.filter(r => f.fys.has(r.fy));
  if(f.quarters.size) d = d.filter(r => f.quarters.has(r.quarter));
  if(f.months.size) d = d.filter(r => f.months.has(r.month));

  state.data = d;
}

/* =========================
   RENDER FILTER PANEL
========================= */
function renderFilterControls(){
  const d = state.derived;

  // business name (radio)
  const bn = document.getElementById("businessNameWrap");
  bn.innerHTML = "";
  d.businessNames.forEach(name=>{
    bn.innerHTML += `
      <label style="display:flex;gap:8px;align-items:center">
        <input type="radio" name="bn" value="${name}" ${state.filters.businessName===name?"checked":""}>
        ${name}
      </label>`;
  });

  // zones
  const zw = document.getElementById("zoneWrap");
  zw.innerHTML="";
  d.zones.forEach(z=>{
    zw.innerHTML += `
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" class="zone" data-val="${z}" ${state.filters.zones.has(z)?"checked":""}>
        ${z}
      </label>`;
  });

  // states
  const sw = document.getElementById("stateWrap");
  sw.innerHTML="";
  d.states.forEach(s=>{
    sw.innerHTML += `
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" class="state" data-val="${s}" ${state.filters.states.has(s)?"checked":""}>
        ${s}
      </label>`;
  });

  // cities
  const cw = document.getElementById("cityWrap");
  cw.innerHTML="";
  d.cities.forEach(c=>{
    cw.innerHTML += `
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" class="city" data-val="${c}" ${state.filters.cities.has(c)?"checked":""}>
        ${c}
      </label>`;
  });

  // stores
  const st = document.getElementById("storeWrap");
  st.innerHTML="";
  d.stores.forEach(s=>{
    st.innerHTML += `
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" class="store" data-val="${s}" ${state.filters.stores.has(s)?"checked":""}>
        ${s}
      </label>`;
  });

  // mall types
  const mt = document.getElementById("mallWrap");
  mt.innerHTML="";
  d.mallTypes.forEach(m=>{
    mt.innerHTML+=`
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" class="mall" data-val="${m}" ${state.filters.mallTypes.has(m)?"checked":""}>
        ${m}
      </label>`;
  });

  // sentiments
  const se = document.getElementById("sentimentWrap");
  se.innerHTML="";
  ["Positive","Neutral","Negative"].forEach(s=>{
    se.innerHTML += `
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" class="sent" data-val="${s}" ${state.filters.sentiments.has(s)?"checked":""}>
        ${s}
      </label>`;
  });

  // FY
  const fy = document.getElementById("fyWrap");
  fy.innerHTML="";
  d.fys.forEach(f=>{
    fy.innerHTML += `
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" class="fy" data-val="${f}" ${state.filters.fys.has(f)?"checked":""}>
        ${f}
      </label>`;
  });

  // quarters
  const qr = document.getElementById("quarterWrap");
  qr.innerHTML="";
  d.quarters.forEach(q=>{
    qr.innerHTML += `
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" class="q" data-val="${q}" ${state.filters.quarters.has(q)?"checked":""}>
        ${q}
      </label>`;
  });

  // months
  const mo = document.getElementById("monthWrap");
  mo.innerHTML="";
  MONTH_ORDER.forEach(m=>{
    if(!d.months.includes(m)) return;
    mo.innerHTML += `
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" class="m" data-val="${m}" ${state.filters.months.has(m)?"checked":""}>
        ${m}
      </label>`;
  });

  attachFilterListeners();
}

/* =========================
   FILTER EVENT LISTENERS
========================= */
function attachFilterListeners(){
  document.querySelectorAll("input[name='bn']").forEach(r=>{
    r.onclick = ()=>{ state.filters.businessName = r.value; renderEverything(); };
  });

  const bindSet = (cls,set)=>
    document.querySelectorAll("."+cls).forEach(cb=>{
      cb.onchange = ()=>{
        const v = cb.dataset.val;
        if(cb.checked) set.add(v);
        else set.delete(v);
      };
    });

  bindSet("zone", state.filters.zones);
  bindSet("state", state.filters.states);
  bindSet("city", state.filters.cities);
  bindSet("store", state.filters.stores);
  bindSet("mall", state.filters.mallTypes);
  bindSet("sent", state.filters.sentiments);
  bindSet("fy", state.filters.fys);
  bindSet("q", state.filters.quarters);
  bindSet("m", state.filters.months);
}

/* =========================
   KPIs
========================= */
function renderKPIs(){
  const d = state.data;
  const total = d.length;

  document.getElementById("kpiTotal").textContent = total;

  const neg = d.filter(r=>r.sentiment==="Negative").length;
  const pct = total ? (neg/total*100).toFixed(1)+"%" : "0%";
  document.getElementById("kpiNegative").textContent = pct;

  // Best & worst stores
  let storeMap = {};
  d.forEach(r=>{
    if(!storeMap[r.storeCode]) storeMap[r.storeCode] = {sum:0,count:0};
    storeMap[r.storeCode].sum += r.rating;
    storeMap[r.storeCode].count++;
  });

  let arr = Object.entries(storeMap)
    .map(([s,v])=>({s,avg:v.sum/v.count}))
    .sort((a,b)=>b.avg-a.avg);

  document.getElementById("kpiBest").textContent =
    arr.length ? `${arr[0].s} (${arr[0].avg.toFixed(2)})` : "—";

  document.getElementById("kpiWorst").textContent =
    arr.length ? `${arr[arr.length-1].s} (${arr[arr.length-1].avg.toFixed(2)})` : "—";
}

/* =========================
   DRIVERS BAR CHART
========================= */
function renderDriversChart(){
  const cat = {};
  state.data.forEach(r=>{
    const c = classifyImprovementCategory(r.comment);
    if(c !== "Miscellaneous") cat[c] = (cat[c]||0)+1;
  });

  const arr = Object.entries(cat)
    .map(([k,v])=>({k,v}))
    .sort((a,b)=>b.v-a.v);

  const chart = document.getElementById("driversChart");
  chart.innerHTML="";

  const width = chart.clientWidth || 600;
  const height = arr.length*30+20;

  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("width","100%");
  svg.setAttribute("height",height);

  const max = Math.max(...arr.map(a=>a.v),1);

  arr.forEach((a,i)=>{
    const y = i*30 + 10;
    const barW = (a.v/max)*(width-200);

    const label = document.createElementNS(svg.namespaceURI,"text");
    label.setAttribute("x",10);
    label.setAttribute("y",y+12);
    label.textContent = a.k;
    svg.appendChild(label);

    const rect = document.createElementNS(svg.namespaceURI,"rect");
    rect.setAttribute("x",150);
    rect.setAttribute("y",y);
    rect.setAttribute("height",18);
    rect.setAttribute("width",barW);
    rect.setAttribute("fill","#bfdbfe");
    svg.appendChild(rect);

    const val = document.createElementNS(svg.namespaceURI,"text");
    val.setAttribute("x",150+barW+6);
    val.setAttribute("y",y+12);
    val.textContent = a.v;
    svg.appendChild(val);
  });

  chart.appendChild(svg);
}

/* =========================
   PIE CHART
========================= */
function renderSentimentPie(){
  const data = state.data;
  const cnt = {Positive:0,Neutral:0,Negative:0};
  data.forEach(r=>cnt[r.sentiment]++);
  const total = cnt.Positive+cnt.Neutral+cnt.Negative || 1;

  const pie = document.getElementById("pieChart");
  pie.innerHTML="";

  const size = 180, r = size/2;
  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("width",size);
  svg.setAttribute("height",size);

  let start = -Math.PI/2;
  Object.entries(cnt).forEach(([k,v])=>{
    const slice = (v/total)*Math.PI*2;
    const end = start + slice;

    const x1 = r + r*Math.cos(start);
    const y1 = r + r*Math.sin(start);
    const x2 = r + r*Math.cos(end);
    const y2 = r + r*Math.sin(end);

    const path = document.createElementNS(svg.namespaceURI,"path");
    const d = `M ${r} ${r} L ${x1} ${y1} A ${r} ${r} 0 ${slice>Math.PI?1:0} 1 ${x2} ${y2} Z`;
    path.setAttribute("d",d);
    path.setAttribute("fill", SENTIMENT_COLORS[k]);
    svg.appendChild(path);

    start = end;
  });

  pie.appendChild(svg);
}

/* =========================
   WORD CLOUD
========================= */
function renderWordCloud(){
  const wc = document.getElementById("wordCloud");
  wc.innerHTML="";

  const em = {};
  state.data.forEach(r=>{
    detectEmotions(r.comment).forEach(e=> em[e]=(em[e]||0)+1);
  });

  const total = Object.values(em).reduce((a,b)=>a+b,0) || 1;

  Object.entries(em)
    .sort((a,b)=>b[1]-a[1])
    .forEach(([word,count])=>{
      const el = document.createElement("div");
      el.style.fontSize = 12 + (count/total)*22 + "px";
      el.textContent = word;
      wc.appendChild(el);
    });
}

/* =========================
   LINE CHART APR→MAR
========================= */
function renderLineChart(){
  const map={};
  MONTH_ORDER.forEach(m=> map[m]={sum:0,count:0});

  state.data.forEach(r=>{
    if(map[r.month]){
      map[r.month].sum += sentimentScore(r.sentiment);
      map[r.month].count++;
    }
  });

  const points = MONTH_ORDER.map(m =>
    map[m].count ? map[m].sum/map[m].count : 0
  );

  const chart = document.getElementById("lineChart");
  chart.innerHTML="";

  const width = chart.clientWidth || 600;
  const height = 220;
  const pad = 40;

  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("width","100%");
  svg.setAttribute("height",height);

  const x = i => pad + i*((width-pad*2)/(MONTH_ORDER.length-1));
  const y = v => pad + (1-(v+1)/2)*(height-pad*2);

  const pathD = points.map((p,i)=>`${i?"L":"M"} ${x(i)} ${y(p)}`).join(" ");
  const path = document.createElementNS(svg.namespaceURI,"path");
  path.setAttribute("d",pathD);
  path.setAttribute("fill","none");
  path.setAttribute("stroke","#0f172a");
  path.setAttribute("stroke-width","2");
  svg.appendChild(path);

  chart.appendChild(svg);
}

/* =========================
   HEATMAP
========================= */
function renderHeatmap(){
  const storeCat={};
  state.rawData.forEach(r=>{
    const c = classifyImprovementCategory(r.comment);
    if(c==="Miscellaneous") return;
    if(!storeCat[r.storeCode]) storeCat[r.storeCode]={};
    if(!storeCat[r.storeCode][c]) storeCat[r.storeCode][c]={score:0,count:0};
    storeCat[r.storeCode][c].score += sentimentScore(r.sentiment);
    storeCat[r.storeCode][c].count++;
  });

  const storeCount={};
  state.rawData.forEach(r=> storeCount[r.storeCode]=(storeCount[r.storeCode]||0)+1);

  const topStores = Object.entries(storeCount)
    .map(([s,c])=>({s,c}))
    .sort((a,b)=>b.c-a.c)
    .slice(0,10)
    .map(x=>x.s);

  const cats = [...new Set(
    Object.values(storeCat).flatMap(o=>Object.keys(o))
  )];

  const tbl = document.getElementById("heatmapTable");
  tbl.innerHTML="";

  let thead = "<tr><th>Store</th>";
  cats.forEach(c=> thead+=`<th>${c}</th>`);
  thead+="</tr>";
  tbl.innerHTML = thead;

  topStores.forEach(s=>{
    let row = `<tr><th style="cursor:pointer" onclick="showStoreDrill('${s}')">${s}</th>`;
    cats.forEach(c=>{
      let cell = storeCat[s] && storeCat[s][c] ? storeCat[s][c] : {score:0,count:0};
      let avg = cell.count ? (cell.score/cell.count) : 0;
      let bg = avg>0 ? `rgba(16,185,129,${Math.abs(avg)})`
            : avg<0 ? `rgba(239,68,68,${Math.abs(avg)})`
            : `rgba(245,158,11,0.2)`;
      row+=`<td style="background:${bg}">${cell.count?avg.toFixed(2)+" ("+cell.count+")":"-"}</td>`;
    });
    row+="</tr>";
    tbl.innerHTML += row;
  });
}

/* =========================
   ZONE CHART
========================= */
function renderZoneChart(){
  const map={};
  state.data.forEach(r=>{
    if(!map[r.zone]) map[r.zone]={sum:0,count:0};
    map[r.zone].sum += sentimentScore(r.sentiment);
    map[r.zone].count++;
  });

  const arr = Object.entries(map)
    .map(([z,v])=>({z,avg:v.sum/v.count}))
    .sort((a,b)=>b.avg-a.avg);

  const chart = document.getElementById("zoneChart");
  chart.innerHTML="";

  const width = chart.clientWidth || 400;
  const height = 220;
  const pad = 30;

  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("width","100%");
  svg.setAttribute("height",height);

  arr.forEach((a,i)=>{
    const bw = (width-pad*2)/arr.length;
    const barH = ((a.avg+1)/2)*(height-pad*2);
    const x = pad + i*bw + 5;
    const y = height-pad - barH;

    const rect = document.createElementNS(svg.namespaceURI,"rect");
    rect.setAttribute("x",x);
    rect.setAttribute("y",y);
    rect.setAttribute("width",bw-10);
    rect.setAttribute("height",barH);
    rect.setAttribute("rx",6);
    rect.setAttribute("fill", a.avg>=0 ? SENTIMENT_COLORS.Positive : SENTIMENT_COLORS.Negative);
    svg.appendChild(rect);

    const tx = document.createElementNS(svg.namespaceURI,"text");
    tx.setAttribute("x", x+(bw-10)/2);
    tx.setAttribute("y", height-5);
    tx.setAttribute("text-anchor","middle");
    tx.textContent = a.z;
    svg.appendChild(tx);
  });

  chart.appendChild(svg);
}

/* =========================
   COMMENTS
========================= */
function renderComments(){
  const sorted = state.data
    .map(r=>({...r, date:new Date(r.commentDate)}))
    .sort((a,b)=> b.date-a.date);

  const pos = sorted.filter(r=>r.sentiment==="Positive").slice(0,15);
  const neg = sorted.filter(r=>r.sentiment==="Negative").slice(0,15);

  const pw = document.getElementById("positiveComments");
  const nw = document.getElementById("negativeComments");
  pw.innerHTML=""; nw.innerHTML="";

  pos.forEach(r=>{
    pw.innerHTML += `
      <div class="comment-card">
        <b>${escapeHtml(r.comment)}</b>
        <div class="comment-meta">Store: ${r.storeCode} | ${formatDateYMD(r.commentDate)}</div>
      </div>`;
  });

  neg.forEach(r=>{
    nw.innerHTML += `
      <div class="comment-card">
        <b>${escapeHtml(r.comment)}</b>
        <div class="comment-meta">Store: ${r.storeCode} | ${formatDateYMD(r.commentDate)}</div>
      </div>`;
  });
}

/* =========================
   DOWNLOAD CSV
========================= */
function downloadFilteredCSV(){
  const data = state.data;
  if(!data.length) return alert("No data to download.");

  const cols = ["storeCode","businessName","zone","state","city","mallType","fy","quarter","month","rating","sentiment","commentDate","comment"];

  const lines = [
    cols.join(","),
    ...data.map(r =>
      cols.map(c => `"${String(r[c]||"").replace(/"/g,'""')}"`).join(",")
    )
  ];

  const blob = new Blob([lines.join("\n")],{type:"text/csv"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "filtered_reviews.csv";
  a.click();
}

/* =========================
   EXPORT PDF
========================= */
async function exportDashboardPDF(){
  const main = document.querySelector(".main");
  const canvas = await html2canvas(main,{scale:1.2});
  const img = canvas.toDataURL("image/png");

  const pdf = new jspdf.jsPDF("landscape","pt","a4");
  const pw = pdf.internal.pageSize.getWidth();
  const ph = pdf.internal.pageSize.getHeight();

  pdf.addImage(img,"PNG",10,10,pw-20,ph-20);
  pdf.save("dashboard.pdf");
}

/* =========================
   THEME SWITCHING
========================= */
function setTheme(cls){
  const root = document.getElementById("appRoot");
  root.classList.remove("theme-dark","theme-ocean","theme-warm");
  if(cls) root.classList.add(cls);
}

/* =========================
   DRILL DOWN MODAL
========================= */
function showStoreDrill(store){
  const modal = document.getElementById("modalBackdrop");
  const body = document.getElementById("modalBody");

  const rows = state.rawData.filter(r=>r.storeCode===store);
  if(!rows.length){
    body.innerHTML = `<p>No data found.</p>`;
  } else {
    let avg = (rows.reduce((a,b)=>a+b.rating,0) / rows.length).toFixed(2);

    let pos = rows.filter(r=>r.sentiment==="Positive").length;
    let neg = rows.filter(r=>r.sentiment==="Negative").length;

    let top = rows.slice(0,10).map(r=>`• ${escapeHtml(r.comment)}`).join("<br>");

    body.innerHTML = `
      <p><b>Store:</b> ${store}</p>
      <p><b>Avg Rating:</b> ${avg}</p>
      <p><b>Sentiments:</b> +${pos} / -${neg}</p>
      <p><b>Recent Feedback:</b><br>${top}</p>
    `;
  }

  modal.style.display = "flex";
}

document.getElementById("closeModal").onclick = () =>
  document.getElementById("modalBackdrop").style.display="none";

/* =========================
   RENDER EVERYTHING
========================= */
function renderEverything(){
  applyFilters();
  renderKPIs();
  renderDriversChart();
  renderSentimentPie();
  renderWordCloud();
  renderLineChart();
  renderHeatmap();
  renderZoneChart();
  renderComments();
}

/* =========================
   INIT
========================= */
(async function(){
  const json = await loadReviewData();

  state.rawData = json.map(r=>normalizeRecord(r));

  refreshDerivedLists(state.rawData);

  if(state.derived.businessNames.length)
    state.filters.businessName = state.derived.businessNames[0];

  renderFilterControls();
  renderEverything();
})();

/* END SCRIPT */
</script>
</body>
</html>
