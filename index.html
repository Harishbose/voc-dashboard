<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voice of Customer â€” Google Reviews</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f1f3f5;
    --card:#ffffff;
    --muted:#6b7280;
    --blue:#0b4a83;
    --positive:#10b981;
    --negative:#ef4444;
    --neutral:#f59e0b;
    --glass: rgba(255,255,255,0.85);
    font-family: Roboto, system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#0f172a}
  .app { min-height:100vh; display:flex; flex-direction:column; transition:margin-left .25s ease; }
  /* Drawer */
  .drawer { position:fixed; left:0; top:0; bottom:0; width:340px; background:var(--card); box-shadow: 4px 0 18px rgba(2,6,23,0.08); padding:16px; overflow:auto; transform:translateX(-360px); transition:transform .25s ease; z-index:60; border-right:1px solid rgba(2,6,23,0.03)}
  .drawer.open{ transform:translateX(0); }
  .drawer .header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
  .drawer h3{ margin:0; font-size:18px; color:var(--blue) }
  .drawer .close{ border-radius:8px; padding:6px 8px; border:1px solid rgba(2,6,23,0.06); cursor:pointer; background:#fff }
  /* push behavior */
  body.drawer-open .content-wrap{ margin-left:340px; transition:margin-left .25s ease; }
  /* Topbar */
  .topbar{ padding:28px 32px 8px; display:flex; align-items:center; justify-content:center; position:relative; gap:12px }
  .filter-toggle{ position:absolute; left:16px; top:28px; border-radius:8px; padding:8px 12px; background:var(--card); box-shadow:0 6px 18px rgba(2,6,23,0.06); cursor:pointer; border:1px solid rgba(2,6,23,0.04)}
  .title{ text-align:center }
  .title h1{ margin:0; font-size:24px; font-weight:700 }
  .title p{ margin:4px 0 0; color:var(--muted) }
  /* KPIs */
  .kpis { display:flex; gap:16px; justify-content:center; margin-top:18px; flex-wrap:wrap }
  .kpi { width:220px; background:var(--card); padding:18px; border-radius:12px; box-shadow:0 6px 18px rgba(2,6,23,0.04); text-align:left }
  .kpi .label{ color:var(--muted); font-size:13px }
  .kpi .value{ font-size:28px; font-weight:700; margin-top:8px }
  .controls-row{ display:flex; gap:12px; justify-content:center; margin-top:12px }
  .btn { padding:8px 12px; border-radius:8px; background:var(--card); border:1px solid rgba(2,6,23,0.06); cursor:pointer }
  /* Layout grid */
  .content-wrap{ padding:18px 28px 48px; transition:margin-left .25s ease; }
  .insights-grid { display:grid; grid-template-columns: repeat(3,1fr); gap:14px; margin-top:20px }
  .insight-card{ background:var(--card); border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(2,6,23,0.04) }
  .dashboard-grid{ display:grid; grid-template-columns: 1fr 420px; gap:16px; margin-top:18px; align-items:start }
  .card{ background:var(--card); border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(2,6,23,0.04); overflow:hidden }
  .card h3{ margin:0 0 10px 0; color:var(--blue); font-size:18px }
  .pills{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px }
  .pill { background:#f1f5f9; padding:8px 12px; border-radius:999px; font-weight:500; font-size:13px; cursor:pointer }
  /* driver chart small */
  #driversChart svg{ width:100%; height:200px; display:block }
  /* pie & line */
  #pieChart{ width:100%; height:100%; min-height:220px }
  #lineChart{ width:100%; height:220px }
  /* word cloud */
  .word-cloud{ min-height:120px; display:flex; flex-wrap:wrap; gap:8px; align-items:flex-start }
  .wc-pill{ padding:8px 12px; border-radius:999px; color:white; font-weight:600 }
  /* heatmap compact */
  .heatmap-wrap{ overflow:auto; margin-top:8px }
  .heatmap-table{ border-collapse:collapse; width:100% }
  .heatmap-table th, .heatmap-table td{ padding:8px 10px; border:1px solid rgba(2,6,23,0.04); white-space:nowrap; text-align:center }
  /* comments */
  .comments-row{ display:flex; gap:12px; margin-top:16px }
  .comment-column{ flex:1; max-height:320px; overflow:auto }
  .comment-card{ background:#f8fafc; border-radius:8px; padding:10px; margin-bottom:8px; border:1px solid rgba(2,6,23,0.04) }
  .comment-card b{ display:block }
  /* responsive */
  @media (max-width:1100px){
    .dashboard-grid{ grid-template-columns:1fr }
    .insights-grid{ grid-template-columns:1fr }
    body.drawer-open .content-wrap{ margin-left:0 } /* mobile: overlay */
    .drawer{ width:340px }
  }
  /* small helpers */
  .muted{ color:var(--muted) }
  .center{ text-align:center }
  .value-big{ font-size:28px; font-weight:700 }
  /* tooltip small */
  .tooltip-box{ background:#fff; border:1px solid rgba(2,6,23,0.06); padding:12px; border-radius:8px; box-shadow:0 8px 24px rgba(2,6,23,0.08); }
</style>
</head>
<body>

<!-- Drawer -->
<aside class="drawer" id="drawer">
  <div class="header">
    <h3>Filters</h3>
    <button class="close" id="closeDrawer">Close</button>
  </div>

  <div style="margin-bottom:10px; font-size:13px; color:var(--muted)">Use filters to narrow down reviews. Sections collapse to keep panel tidy.</div>

  <!-- Business section -->
  <details open style="margin-bottom:10px">
    <summary style="font-weight:600;cursor:pointer">Business Name (single-select)</summary>
    <div id="businessNameWrap" style="margin-top:8px"></div>
  </details>

  <!-- Zone -->
  <details style="margin-bottom:10px">
    <summary style="font-weight:600;cursor:pointer">Zone</summary>
    <div id="zoneWrap" style="margin-top:8px"></div>
  </details>

  <!-- State -->
  <details style="margin-bottom:10px">
    <summary style="font-weight:600;cursor:pointer">State</summary>
    <input id="stateSearch" placeholder="Search state..." style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);margin-top:8px"/>
    <div id="stateWrap" style="margin-top:8px; max-height:220px; overflow:auto"></div>
  </details>

  <!-- City -->
  <details style="margin-bottom:10px">
    <summary style="font-weight:600;cursor:pointer">City</summary>
    <input id="citySearch" placeholder="Search city..." style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);margin-top:8px"/>
    <div id="cityWrap" style="margin-top:8px; max-height:180px; overflow:auto"></div>
  </details>

  <!-- Store -->
  <details style="margin-bottom:10px">
    <summary style="font-weight:600;cursor:pointer">Store</summary>
    <input id="storeSearch" placeholder="Search store..." style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);margin-top:8px"/>
    <div id="storeWrap" style="margin-top:8px; max-height:180px; overflow:auto"></div>
  </details>

  <!-- other small filters -->
  <details style="margin-bottom:10px">
    <summary style="font-weight:600;cursor:pointer">Mall Type</summary>
    <div id="mallWrap" style="margin-top:8px"></div>
  </details>

  <details style="margin-bottom:10px">
    <summary style="font-weight:600;cursor:pointer">Sentiment</summary>
    <div id="sentimentWrap" style="margin-top:8px"></div>
  </details>

  <details style="margin-bottom:10px">
    <summary style="font-weight:600;cursor:pointer">FY / Quarter / Month</summary>
    <div id="fyWrap" style="margin-top:8px"></div>
    <div id="quarterWrap" style="margin-top:8px"></div>
    <div id="monthWrap" style="margin-top:8px"></div>
  </details>

  <div style="display:flex; gap:8px; margin-top:12px">
    <button class="btn" id="applyFilters">Apply</button>
    <button class="btn" id="resetFilters">Reset</button>
  </div>

  <div style="height:26px"></div>
</aside>

<!-- Page -->
<div class="app" id="app">
  <div class="topbar">
    <button class="filter-toggle" id="openDrawer">Filters</button>
    <div class="title">
      <h1>Voice of Customer â€” Google Reviews</h1>
      <p>Interactive Analytics Dashboard</p>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi">
          <div class="label">Total Reviews</div>
          <div class="value" id="kpiTotal">0</div>
        </div>
        <div class="kpi">
          <div class="label">% Negative Reviews</div>
          <div class="value" id="kpiNegative">0%</div>
        </div>
        <div class="kpi">
          <div class="label">Best Store</div>
          <div class="value" id="kpiBest">â€”</div>
        </div>
        <div class="kpi">
          <div class="label">Worst Store</div>
          <div class="value" id="kpiWorst">â€”</div>
        </div>
      </div>

      <div class="controls-row">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="btn" id="resetFiltersHeader">Reset Filters</button>
      </div>
    </div>
  </div>

  <div class="content-wrap">
    <!-- strategic insights -->
    <h2 style="margin:18px 0 8px 4px; color:var(--blue)">Strategic Insights</h2>
    <div class="insights-grid" id="insightsGrid">
      <!-- cards inserted by JS -->
    </div>

    <!-- main grid -->
    <div class="dashboard-grid" style="margin-top:18px">
      <div>
        <div class="card">
          <h3>Key Drivers of Customer Feedback (All Sentiments)</h3>
          <div class="pills" id="driverPills"></div>
          <div id="driversChart"></div>
        </div>

        <div class="card" style="margin-top:16px">
          <h3>Emotion Word Cloud</h3>
          <div class="word-cloud" id="wordCloud"></div>
        </div>

        <div class="card" style="margin-top:16px">
          <h3>Store Sentiment Heatmap (Top stores Ã— Categories)</h3>
          <div class="heatmap-wrap" id="heatmapWrap">
            <table class="heatmap-table" id="heatmapTable"></table>
          </div>
        </div>

        <div class="comments-row" style="margin-top:16px">
          <div class="comment-column card">
            <h3 style="margin-top:0">Positive Comments (Top 15) â€“ By Date</h3>
            <div id="positiveComments"></div>
          </div>
          <div class="comment-column card">
            <h3 style="margin-top:0">Negative Comments (Top 15) â€“ By Date</h3>
            <div id="negativeComments"></div>
          </div>
        </div>
      </div>

      <div>
        <div class="card" style="margin-bottom:16px">
          <h3>Sentiment Distribution</h3>
          <div id="pieChart"></div>
        </div>

        <div class="card" style="margin-bottom:16px">
          <h3>Sentiment Trend Over Time (APR â†’ MAY â†’ JUN)</h3>
          <div id="lineChart"></div>
        </div>

        <div class="card">
          <h3>Sentiment by Zone</h3>
          <div id="zoneChart"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ========== Config ========== */
const API_URLS = [
  "https://raw.githubusercontent.com/Harishbose/voc-dashboard/main/reviews.json"
];
const MONTH_ORDER = ['APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC','JAN','FEB','MAR'];
const SENT_COLORS = { Positive: getComputedStyle(document.documentElement).getPropertyValue('--positive').trim() || '#10b981', Negative: getComputedStyle(document.documentElement).getPropertyValue('--negative').trim() || '#ef4444', Neutral: getComputedStyle(document.documentElement).getPropertyValue('--neutral').trim() || '#f59e0b' };

/* ========== state ========== */
let state = {
  rawData: [],
  data: [],
  filters: {
    businessName: null,
    zones: new Set(),
    states: new Set(),
    cities: new Set(),
    stores: new Set(),
    mallTypes: new Set(),
    sentiments: new Set(),
    fys: new Set(),
    quarters: new Set(),
    months: new Set()
  },
  derived: {}
};

/* ===== helpers ===== */
const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
function uniq(arr){ return Array.from(new Set(arr.map(x=>x===null?'':x))).filter(x=>x!=='').sort(); }
function looksLikeDate(s){
  if(!s) return false;
  return /^\d{4}-\d{2}-\d{2}/.test(s) || /\d{2}\/\d{2}\/\d{4}/.test(s) || /\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/.test(s);
}
function formatDate(d){
  if(!d) return 'N/A';
  const D = new Date(d);
  if(isNaN(D)) return d;
  return (D.getMonth()+1).toString().padStart(2,'0') + '/' + D.getDate().toString().padStart(2,'0') + '/' + D.getFullYear();
}
function sentimentScore(s){ if(s==='Positive') return 1; if(s==='Negative') return -1; return 0; }

/* small heuristics */
function detectEmotions(text){
  if(!text) return [];
  const t = text.toLowerCase();
  const em=[];
  if(/thank|thanks|gratef|appreciat|love|ðŸ˜Š/.test(t)) em.push('Gratitude');
  if(/angry|hate|annoy|furious|ðŸ˜ |mad|rage|terrible|awful|worst/.test(t)) em.push('Frustration');
  if(/happy|great|excellent|pleased|satisfied/.test(t)) em.push('Satisfaction');
  if(/disappointed|sad|upset|not happy|disappoint/.test(t)) em.push('Disappointment');
  if(/confused|unclear|unsure/.test(t)) em.push('Confusion');
  if(/joy|happy/.test(t) && !em.includes('Satisfaction')) em.push('Joy');
  return em;
}
function classifyImprovementCategory(text){
  if(!text) return 'Miscellaneous';
  const t = text.toLowerCase();
  const m = arr => arr.some(k=>t.includes(k));
  if(m(['staff','service','salesman','experience','assistance','interaction'])) return 'Store Experience';
  if(m(['quality','material','product','durability','defect','faulty'])) return 'Product Quality';
  if(m(['collection','variety','size','available','stock','availability'])) return 'Inventory Management';
  if(m(['price','cost','expensive','discount','deal','value'])) return 'Pricing & Discounts';
  if(m(['return','exchange','refund','policy','returnable'])) return 'Return & Refund Policies';
  if(m(['support','help','assistance','responsive','query','resolution'])) return 'Customer Support';
  if(m(['promotion','offer','loyalty','deal','coupon','reward'])) return 'Promotions & Offers';
  if(m(['billing','payment','charge','invoice','transaction'])) return 'Billing & Payment Issues';
  if(m(['behaviour','rude','polite','attitude','courtesy','professionalism'])) return 'Staff Behaviour';
  if(m(['wait','queue','delay','slow','line','turnaround'])) return 'Wait Time / Queue Management';
  return 'Miscellaneous';
}

/* ========== Data load ========== */
async function loadReviewData(){
  for(const url of API_URLS){
    try{
      const res = await fetch(url);
      if(!res.ok) continue;
      const data = await res.json();
      if(Array.isArray(data) && data.length>0) return data;
    }catch(e){ console.warn('load fail', e) }
  }
  alert('Could not load data from backend. Check raw JSON.');
  return [];
}

/* normalization */
function normalizeRecord(r){
  const rec = {};
  rec.rating = (r.rating!==undefined && r.rating!==null && !isNaN(Number(r.rating))) ? Number(r.rating) : (r['Google Rating'] ? Number(r['Google Rating']):0);
  rec.storeCode = r.storeCode || r['storeCode'] || r['Store Name'] || r['store'] || '';
  rec.mallType = r.mallType || r['mallType'] || r['Mall/HS'] || r['mall'] || '';
  rec.businessName = r.businessName || r['businessName'] || r['Brand'] || r['brand'] || '';
  rec.zone = r.zone || r['zone'] || '';
  rec.state = r.state || r['state'] || '';
  rec.city = r.city || r['city'] || '';
  rec.commentDate = r.commentDate || r['commentDate'] || r['Comment Date'] || '';
  rec.month = (r.month || r['month'] || '').toString().toUpperCase();
  rec.quarter = r.quarter || r['quarter'] || '';
  rec.fy = r.fy || r['fy'] || r['Financial Year'] || '';
  rec.sentiment = (r.sentiment || r['sentiment'] || 'Neutral').toString();
  let commentText = r.comment || r['comment'] || r['Customer Response'] || r.responseType || r['responseType'] || '';
  // if the comment looks like a date/time fallback to responseType if available
  if(looksLikeDate(String(commentText)) && r.responseType && r.responseType.length>2) commentText = r.responseType;
  rec.comment = commentText || '';
  rec.__raw = r;
  return rec;
}

/* derived lists */
function refreshDerivedLists(all){
  state.derived.businessNames = uniq(all.map(r=>r.businessName));
  state.derived.zones = uniq(all.map(r=>r.zone));
  state.derived.states = uniq(all.map(r=>r.state));
  state.derived.cities = uniq(all.map(r=>r.city));
  state.derived.stores = uniq(all.map(r=>r.storeCode));
  state.derived.mallTypes = uniq(all.map(r=>r.mallType));
  state.derived.fys = uniq(all.map(r=>r.fy)).reverse();
  state.derived.quarters = uniq(all.map(r=>r.quarter));
  state.derived.months = uniq(all.map(r=>r.month)).filter(x=>MONTH_ORDER.includes(x)).sort((a,b)=> MONTH_ORDER.indexOf(a)-MONTH_ORDER.indexOf(b));
}

/* cascading allowed lists */
function cascadeAllowed(){
  const base = state.rawData;
  const f = state.filters;
  const allowedStates = new Set(), allowedCities = new Set(), allowedStores = new Set();
  base.forEach(r=>{
    if(f.zones.size===0 || f.zones.has(r.zone)) allowedStates.add(r.state);
  });
  base.forEach(r=>{
    if((f.zones.size===0 || f.zones.has(r.zone)) && (f.states.size===0 || f.states.has(r.state))) allowedCities.add(r.city);
  });
  base.forEach(r=>{
    if((f.zones.size===0 || f.zones.has(r.zone)) && (f.states.size===0 || f.states.has(r.state)) && (f.cities.size===0 || f.cities.has(r.city))) allowedStores.add(r.storeCode);
  });
  state.derived.allowedStates = Array.from(allowedStates).sort();
  state.derived.allowedCities = Array.from(allowedCities).sort();
  state.derived.allowedStores = Array.from(allowedStores).sort();
}

/* apply filters */
function applyFilters(){
  const f = state.filters;
  let data = state.rawData.slice();
  if(f.businessName) data = data.filter(r=> r.businessName === f.businessName);
  if(f.zones.size) data = data.filter(r=> f.zones.has(r.zone));
  if(f.states.size) data = data.filter(r=> f.states.has(r.state));
  if(f.cities.size) data = data.filter(r=> f.cities.has(r.city));
  if(f.stores.size) data = data.filter(r=> f.stores.has(r.storeCode));
  if(f.mallTypes.size) data = data.filter(r=> f.mallTypes.has(r.mallType));
  if(f.sentiments.size) data = data.filter(r=> f.sentiments.has(r.sentiment));
  if(f.fys.size) data = data.filter(r=> f.fys.has(r.fy));
  if(f.quarters.size) data = data.filter(r=> f.quarters.has(r.quarter));
  if(f.months.size) data = data.filter(r=> f.months.has(r.month));
  state.data = data;
}

/* ================= Render controls ================= */

function renderFilterControls(){
  cascadeAllowed();
  // business radio
  const bwrap = document.getElementById('businessNameWrap'); bwrap.innerHTML='';
  state.derived.businessNames.forEach(name=>{
    const id = 'bn_'+name.replace(/\s+/g,'_');
    const checked = (state.filters.businessName === name) ? 'checked' : '';
    const div = document.createElement('div'); div.style.marginBottom='6px';
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="radio" name="businessName" ${checked} value="${esc(name)}"> <span>${esc(name)}</span></label>`;
    bwrap.appendChild(div);
  });

  // zones
  const zwrap = document.getElementById('zoneWrap'); zwrap.innerHTML='';
  state.derived.zones.forEach(z=>{
    const div = document.createElement('div');
    const checked = state.filters.zones.has(z) ? 'checked' : '';
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${esc(z)}" class="zone-checkbox" ${checked}/> ${esc(z)}</label>`;
    zwrap.appendChild(div);
  });

  // states
  const swrap = document.getElementById('stateWrap'); swrap.innerHTML='';
  (state.derived.allowedStates.length ? state.derived.allowedStates : state.derived.states).forEach(s=>{
    const div = document.createElement('div');
    const checked = state.filters.states.has(s) ? 'checked' : '';
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${esc(s)}" class="state-checkbox" ${checked}/> ${esc(s)}</label>`;
    swrap.appendChild(div);
  });

  // cities
  const cwrap = document.getElementById('cityWrap'); cwrap.innerHTML='';
  (state.derived.allowedCities.length ? state.derived.allowedCities : state.derived.cities).forEach(c=>{
    const div = document.createElement('div');
    const checked = state.filters.cities.has(c) ? 'checked' : '';
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${esc(c)}" class="city-checkbox" ${checked}/> ${esc(c)}</label>`;
    cwrap.appendChild(div);
  });

  // stores
  const stwrap = document.getElementById('storeWrap'); stwrap.innerHTML='';
  (state.derived.allowedStores.length ? state.derived.allowedStores : state.derived.stores).forEach(s=>{
    const div = document.createElement('div');
    const checked = state.filters.stores.has(s) ? 'checked' : '';
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${esc(s)}" class="store-checkbox" ${checked}/> ${esc(s)}</label>`;
    stwrap.appendChild(div);
  });

  // mall types
  const mwrap = document.getElementById('mallWrap'); mwrap.innerHTML='';
  state.derived.mallTypes.forEach(m=>{
    const div = document.createElement('div');
    const checked = state.filters.mallTypes.has(m) ? 'checked' : '';
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${esc(m)}" class="mall-checkbox" ${checked}/> ${esc(m)}</label>`;
    mwrap.appendChild(div);
  });

  // sentiment
  const sentWrap = document.getElementById('sentimentWrap'); sentWrap.innerHTML='';
  ['Positive','Neutral','Negative'].forEach(s=>{
    const checked = state.filters.sentiments.has(s) ? 'checked' : '';
    const div = document.createElement('div');
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${esc(s)}" class="sent-checkbox" ${checked}/> ${s}</label>`;
    sentWrap.appendChild(div);
  });

  // FY
  const fyw = document.getElementById('fyWrap'); fyw.innerHTML='';
  state.derived.fys.forEach(fy=>{
    const checked = state.filters.fys.has(fy) ? 'checked' : '';
    const div = document.createElement('div'); div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${esc(fy)}" class="fy-checkbox" ${checked}/> ${esc(fy)}</label>`;
    fyw.appendChild(div);
  });

  // quarters
  const qw = document.getElementById('quarterWrap'); qw.innerHTML='';
  state.derived.quarters.forEach(q=>{
    const checked = state.filters.quarters.has(q) ? 'checked' : '';
    const div = document.createElement('div'); div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${esc(q)}" class="q-checkbox" ${checked}/> ${esc(q)}</label>`;
    qw.appendChild(div);
  });

  // months
  const mw = document.getElementById('monthWrap'); mw.innerHTML='';
  MONTH_ORDER.forEach(m=>{
    if(state.derived.months.includes(m)){
      const checked = state.filters.months.has(m) ? 'checked' : '';
      const div = document.createElement('div'); div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${esc(m)}" class="m-checkbox" ${checked}/> ${esc(m)}</label>`;
      mw.appendChild(div);
    }
  });

  attachFilterListeners();
}

function attachFilterListeners(){
  document.querySelectorAll('input[name="businessName"]').forEach(r=>{
    r.addEventListener('change', e=>{
      state.filters.businessName = e.target.value;
    });
  });
  document.querySelectorAll('.zone-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.zones.add(v); else state.filters.zones.delete(v);
    });
  });
  document.querySelectorAll('.state-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.states.add(v); else state.filters.states.delete(v);
      renderFilterControls();
    });
  });
  document.querySelectorAll('.city-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.cities.add(v); else state.filters.cities.delete(v);
      renderFilterControls();
    });
  });
  document.querySelectorAll('.store-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.stores.add(v); else state.filters.stores.delete(v);
    });
  });
  document.querySelectorAll('.mall-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.mallTypes.add(v); else state.filters.mallTypes.delete(v);
    });
  });
  document.querySelectorAll('.sent-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.sentiments.add(v); else state.filters.sentiments.delete(v);
    });
  });
  document.querySelectorAll('.fy-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.fys.add(v); else state.filters.fys.delete(v);
    });
  });
  document.querySelectorAll('.q-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.quarters.add(v); else state.filters.quarters.delete(v);
    });
  });
  document.querySelectorAll('.m-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const v = e.target.dataset.val;
      if(e.target.checked) state.filters.months.add(v); else state.filters.months.delete(v);
    });
  });

  // search boxes
  document.getElementById('stateSearch').addEventListener('input', e=>{
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('#stateWrap > div').forEach(div=>{
      div.style.display = div.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
  document.getElementById('citySearch').addEventListener('input', e=>{
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('#cityWrap > div').forEach(div=>{
      div.style.display = div.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
  document.getElementById('storeSearch').addEventListener('input', e=>{
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('#storeWrap > div').forEach(div=>{
      div.style.display = div.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
}

/* ========== KPIs & Insights ========== */
function renderKPIsAndInsights(){
  const data = state.data;
  const total = data.length;
  const negatives = data.filter(d=>d.sentiment==='Negative').length;
  const negPct = total ? ((negatives/total)*100).toFixed(1) + '%' : '0%';
  document.getElementById('kpiTotal').textContent = total;
  document.getElementById('kpiNegative').textContent = negPct;

  // Best/Worst store logic using weighted score
  const byStore = {};
  state.rawData.forEach(r=>{
    if(!byStore[r.storeCode]) byStore[r.storeCode] = {sum:0,count:0};
    byStore[r.storeCode].sum += Number(r.rating||0);
    byStore[r.storeCode].count++;
  });
  const storeStats = Object.entries(byStore).map(([k,v])=>{
    const avg = v.count ? v.sum / v.count : 0;
    const weighted = avg * Math.log(1 + v.count); // weighted score
    return {store:k,avg, count:v.count, weighted};
  }).filter(s=>s.store && s.count>0);

  storeStats.sort((a,b)=> b.weighted - a.weighted);
  const best = storeStats[0] || null;
  const worst = storeStats.sort((a,b)=>a.avg-b.avg)[0] || null;
  document.getElementById('kpiBest').textContent = best ? `${best.store} (${best.avg.toFixed(2)} / ${best.count})` : 'â€”';
  document.getElementById('kpiWorst').textContent = worst ? `${worst.store} (${worst.avg.toFixed(2)} / ${worst.count})` : 'â€”';

  // Strategic insights (6 cards)
  const grid = document.getElementById('insightsGrid'); grid.innerHTML='';
  const auto = generateTopInsights();
  const strategic = generateStrategicInsights(state.data);
  const all = [...auto, ...strategic];
  all.slice(0,6).forEach(card=>{
    const el = document.createElement('div'); el.className='insight-card';
    el.innerHTML = `<h4 style="margin:0 0 6px 0">${esc(card.headline)}</h4><p class="muted" style="margin:0">${esc(card.description)}</p>`;
    grid.appendChild(el);
  });
}

function generateTopInsights(){
  // produce 3 AI-style cards but not "AI language" â€” use heuristics
  const data = state.data;
  const categories = {};
  data.forEach(r=>{
    const c = classifyImprovementCategory(r.comment);
    if(c==='Miscellaneous') return;
    categories[c] = (categories[c]||0)+1;
  });
  const sorted = Object.entries(categories).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
  const top = sorted[0] || null;
  const cards = [];
  if(top) cards.push({ headline: 'Store Experience Dominates', description: `This was the most mentioned theme, appearing in ${Math.round(top.v)} reviews. It's the key driver of praise and criticism.` });
  cards.push({ headline: 'Top Cities by Volume', description: (()=>{ const cm = {}; state.data.forEach(r=>cm[r.city]=(cm[r.city]||0)+1); const topCities = Object.entries(cm).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]).join(', '); return topCities || 'N/A'; })() });
  return cards;
}

function generateStrategicInsights(data){
  // produce 4 more cards similar to earlier
  // zone dip, underperformers, uptick, leading store
  const categories = {};
  data.forEach(r=>{ const c = classifyImprovementCategory(r.comment); if(c==='Miscellaneous') return; categories[c] = (categories[c]||0)+1; });
  const total = Object.values(categories).reduce((a,b)=>a+b,0) || 1;
  const sortedCats = Object.entries(categories).map(([k,v])=>({k,v, percent: v/total*100})).sort((a,b)=>b.v-a.v);
  const theme = sortedCats[0] ? sortedCats[0].k : 'Store Experience';
  const themePct = sortedCats[0] ? Math.round(sortedCats[0].percent) : 0;

  const zoneStats = {};
  data.forEach(r=>{ if(!zoneStats[r.zone]) zoneStats[r.zone] = {sum:0,count:0,neg:0}; zoneStats[r.zone].sum += r.rating; zoneStats[r.zone].count++; if(r.sentiment==='Negative') zoneStats[r.zone].neg++; });
  const zoneArr = Object.entries(zoneStats).map(([z,v])=>({zone:z,avg:v.count? v.sum/v.count:0, negPct: v.count? v.neg/v.count*100:0 })).sort((a,b)=>b.negPct-a.negPct);
  const topZone = zoneArr[0] || {zone:'N/A', avg:0, negPct:0};

  const storeMap = {};
  data.forEach(r=>{ if(!storeMap[r.storeCode]) storeMap[r.storeCode] = {sum:0,count:0,neg:0}; storeMap[r.storeCode].sum += r.rating; storeMap[r.storeCode].count++; if(r.sentiment==='Negative') storeMap[r.storeCode].neg++; });
  const underperformers = Object.entries(storeMap).map(([s,v])=>({store:s,avg:v.sum/v.count,negPct:v.count? v.neg/v.count*100:0,count:v.count})).filter(x=>x.avg<=4).sort((a,b)=>a.avg-b.avg).slice(0,5).map(x=>x.store);
  const underText = underperformers.length ? underperformers.join(', ') : 'N/A';

  // positive momentum
  const today = new Date();
  const daysAgo = n => { const d = new Date(); d.setDate(d.getDate() - n); return d; };
  const last30 = data.filter(r=> new Date(r.commentDate) >= daysAgo(30));
  const prev30 = data.filter(r=> new Date(r.commentDate) < daysAgo(30) && new Date(r.commentDate) >= daysAgo(60));
  const posLast = last30.filter(r=>r.sentiment==='Positive').length;
  const posPrev = prev30.filter(r=>r.sentiment==='Positive').length;
  const posPctChange = posPrev ? Math.round(((posLast-posPrev)/posPrev)*100) : (posLast?100:0);

  const cityMap = {}; data.forEach(r=> cityMap[r.city] = (cityMap[r.city]||0)+1);
  const topCities = Object.entries(cityMap).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]).join(', ') || 'N/A';

  const best = Object.entries(storeMap).map(([s,v])=>({s,avg:v.sum/v.count})).sort((a,b)=>b.avg-a.avg)[0];
  const bestText = best ? `${best.s} (${best.avg.toFixed(2)})` : 'N/A';

  return [
    { headline: `${theme} is Key`, description: `Top theme: ${theme} (${themePct}%) â€” focus here for improvement.` },
    { headline: `${topZone.zone} Zone Sentiment Dip`, description: `Average rating ${topZone.avg.toFixed(1)}, higher negative share.` },
    { headline: `Stores needing Attention`, description: `Underperformers: ${underText}` },
    { headline: `Uptick in Positive Feedback`, description: `${posPctChange}% change in positive reviews recently.` },
  ];
}

/* ========== Render Charts & Panels ========== */

function renderDriversChart(){
  const data = state.data;
  const categories = {};
  data.forEach(r=>{ const c = classifyImprovementCategory(r.comment); if(c==='Miscellaneous') return; categories[c] = (categories[c]||0)+1; });
  const arr = Object.entries(categories).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
  const total = arr.reduce((a,b)=>a+b.v,0) || 1;
  let others = 0;
  const filtered = arr.filter(item=> {
    if(item.v/total < 0.05){ others += item.v; return false; }
    return true;
  });
  if(others) filtered.push({k:'Miscellaneous/Others', v:others});
  filtered.sort((a,b)=>b.v-a.v);

  const pillWrap = document.getElementById('driverPills'); pillWrap.innerHTML='';
  filtered.forEach(item=>{
    const p = document.createElement('div'); p.className='pill'; p.textContent = `${item.k} (${item.v})`;
    pillWrap.appendChild(p);
  });

  const chart = document.getElementById('driversChart');
  chart.innerHTML = '';
  const width = chart.clientWidth || 720;
  const height = Math.max(120, filtered.length*36);
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('width','100%'); svg.setAttribute('height', height);
  const max = Math.max(...filtered.map(f=>f.v),1);
  filtered.forEach((f,i)=>{
    const y = i*36 + 12;
    const label = document.createElementNS(svgNS,'text'); label.setAttribute('x',10); label.setAttribute('y', y+14); label.setAttribute('font-size','12'); label.setAttribute('fill','#0b1220'); label.textContent = f.k;
    svg.appendChild(label);
    const barW = Math.round((f.v/max) * (width - 220));
    const rect = document.createElementNS(svgNS,'rect'); rect.setAttribute('x',200); rect.setAttribute('y', y+2); rect.setAttribute('width', barW); rect.setAttribute('height',18); rect.setAttribute('rx',8); rect.setAttribute('fill','rgba(16,185,129,0.15)');
    svg.appendChild(rect);
    const inner = document.createElementNS(svgNS,'rect'); inner.setAttribute('x',200); inner.setAttribute('y', y+2); inner.setAttribute('width', Math.max(8, barW*0.98)); inner.setAttribute('height',18); inner.setAttribute('rx',8); inner.setAttribute('fill','#10b981');
    svg.appendChild(inner);
    const val = document.createElementNS(svgNS,'text'); val.setAttribute('x', 200 + barW + 10); val.setAttribute('y', y+15); val.setAttribute('font-size','12'); val.setAttribute('fill','#0b1220'); val.setAttribute('font-weight','700'); val.textContent = f.v;
    svg.appendChild(val);
  });
  chart.appendChild(svg);
}

/* pie chart */
function renderSentimentPie(){
  const counts = {Positive:0, Neutral:0, Negative:0};
  state.data.forEach(d=> counts[d.sentiment] = (counts[d.sentiment]||0) + 1);
  const total = counts.Positive + counts.Neutral + counts.Negative || 1;
  const el = document.getElementById('pieChart'); el.innerHTML='';
  // using simple canvas to avoid external libs
  const canvas = document.createElement('canvas'); canvas.width = 360; canvas.height = 220;
  const ctx = canvas.getContext('2d');
  let start = -Math.PI/2;
  const radius = 80;
  const cx = 110, cy = 110;
  const slices = [['Positive', counts.Positive, SENT_COLORS.Positive], ['Neutral', counts.Neutral, SENT_COLORS.Neutral], ['Negative', counts.Negative, SENT_COLORS.Negative]];
  slices.forEach(([k,v,color])=>{
    const slice = (v/total) * (Math.PI*2);
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radius, start, start + slice);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
    start += slice;
  });
  el.appendChild(canvas);
  // legend
  const legend = document.createElement('div'); legend.style.marginLeft='8px'; legend.style.display='inline-block'; legend.style.verticalAlign='top';
  [['Positive',counts.Positive,SENT_COLORS.Positive],['Neutral',counts.Neutral,SENT_COLORS.Neutral],['Negative',counts.Negative,SENT_COLORS.Negative]].forEach(([k,v,color])=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='10px'; row.style.margin='8px 0';
    const sw = document.createElement('div'); sw.style.width='14px'; sw.style.height='14px'; sw.style.borderRadius='6px'; sw.style.background = color;
    const label = document.createElement('div'); label.innerHTML = `<strong style="font-weight:700">${k}</strong> â€” ${(v/total*100).toFixed(1)}% (${v})`; label.style.color='#0b1220';
    row.appendChild(sw); row.appendChild(label); legend.appendChild(row);
  });
  el.appendChild(legend);
}

/* line chart APR MAY JUN static points with hover */
function renderLineChart(){
  // compute counts for APR, MAY, JUN
  const months = ['APR','MAY','JUN'];
  const counts = { 'APR': {Positive:0,Negative:0,Neutral:0}, 'MAY': {Positive:0,Negative:0,Neutral:0}, 'JUN': {Positive:0,Negative:0,Neutral:0} };
  state.data.forEach(r=>{
    if(months.includes(r.month)){
      counts[r.month][r.sentiment] = (counts[r.month][r.sentiment]||0) + 1;
    }
  });
  const points = months.map(m=> ({ month:m, pos:counts[m].Positive, neg:counts[m].Negative, neu:counts[m].Neutral, total: counts[m].Positive + counts[m].Negative + counts[m].Neutral }));
  // draw svg
  const chart = document.getElementById('lineChart'); chart.innerHTML='';
  const w = chart.clientWidth || 420; const h = 240; const padding = 40;
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('width','100%'); svg.setAttribute('height',h); svg.setAttribute('viewBox',`0 0 ${w} ${h}`);
  // find max y
  const maxY = Math.max(...points.map(p=>p.pos), 1);
  const xScale = i => padding + i * ((w - padding*2)/(points.length-1));
  const yScale = v => padding + (1 - (v / (maxY || 1))) * (h - padding*2);
  // grid lines
  for(let i=0;i<=4;i++){
    const y = padding + i*((h - padding*2)/4);
    const line = document.createElementNS(svgNS,'line'); line.setAttribute('x1',padding); line.setAttribute('x2', w-padding); line.setAttribute('y1',y); line.setAttribute('y2',y); line.setAttribute('stroke','rgba(2,6,23,0.06)'); svg.appendChild(line);
  }
  // axis labels
  points.forEach((p,i)=>{
    const tx = document.createElementNS(svgNS,'text'); tx.setAttribute('x', xScale(i)); tx.setAttribute('y', h - 8); tx.setAttribute('text-anchor','middle'); tx.setAttribute('font-size','12'); tx.textContent = p.month; svg.appendChild(tx);
  });
  // single positive curve
  const dPos = points.map((p,i)=> `${i===0?'M':'L'} ${xScale(i)} ${yScale(p.pos)}`).join(' ');
  const path = document.createElementNS(svgNS,'path'); path.setAttribute('d', dPos); path.setAttribute('fill','none'); path.setAttribute('stroke',SENT_COLORS.Positive); path.setAttribute('stroke-width','2.5'); svg.appendChild(path);
  // points and hover tooltip
  points.forEach((p,i)=>{
    const cx = xScale(i), cy = yScale(p.pos);
    const circle = document.createElementNS(svgNS,'circle'); circle.setAttribute('cx',cx); circle.setAttribute('cy',cy); circle.setAttribute('r',6); circle.setAttribute('fill','#fff'); circle.setAttribute('stroke',SENT_COLORS.Positive); circle.setAttribute('stroke-width',2); svg.appendChild(circle);
    // label
    const label = document.createElementNS(svgNS,'text'); label.setAttribute('x',cx); label.setAttribute('y',cy - 12); label.setAttribute('font-size','12'); label.setAttribute('text-anchor','middle'); label.setAttribute('font-weight','700'); label.textContent = p.pos; svg.appendChild(label);
    // hover rect (invisible area)
    const rect = document.createElementNS(svgNS,'rect'); rect.setAttribute('x', i>0? xScale(i-1):0); rect.setAttribute('y',0); rect.setAttribute('width', i<points.length-1? xScale(i+1)-xScale(i-1):50); rect.setAttribute('height',h); rect.setAttribute('fill','transparent');
    rect.addEventListener('mouseenter', (ev)=>{
      showTooltipAt(ev.clientX, ev.clientY, `<div style="font-weight:700">${p.month}</div><div style="color:${SENT_COLORS.Positive}">POSITIVE: ${p.pos}</div><div style="color:${SENT_COLORS.Negative}">NEGATIVE: ${p.neg}</div><div style="color:${SENT_COLORS.Neutral}">NEUTRAL: ${p.neu}</div>`);
    });
    rect.addEventListener('mouseleave', hideTooltip);
    svg.appendChild(rect);
  });

  chart.appendChild(svg);
}

let ttTimeout=null;
function showTooltipAt(x,y,html){
  hideTooltip();
  const tt = document.createElement('div'); tt.className='tooltip-box'; tt.id='chartTooltip'; tt.style.position='fixed'; tt.style.left=(x+12)+'px'; tt.style.top=(y+6)+'px'; tt.style.zIndex=9999; tt.innerHTML = html;
  document.body.appendChild(tt);
}
function hideTooltip(){ const t = document.getElementById('chartTooltip'); if(t) t.remove(); }

/* word cloud */
function renderWordCloud(){
  const wc = document.getElementById('wordCloud'); wc.innerHTML='';
  const counts = {};
  state.data.forEach(r=> detectEmotions(r.comment).forEach(e=> counts[e] = (counts[e]||0)+1));
  const total = Object.values(counts).reduce((a,b)=>a+b,0) || 1;
  const colors = ['#34d399','#10b981','#06b6d4','#f59e0b','#ef4444','#60a5fa','#7c3aed'];
  Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([k,v],idx)=>{
    const el = document.createElement('div'); el.className='wc-pill'; el.style.background = colors[idx % colors.length]; el.textContent = `${k} (${v})`;
    wc.appendChild(el);
  });
}

/* heatmap */
function renderHeatmap(){
  const storeCat = {};
  state.rawData.forEach(r=>{
    const cat = classifyImprovementCategory(r.comment);
    if(cat==='Miscellaneous') return;
    if(!storeCat[r.storeCode]) storeCat[r.storeCode] = {};
    if(!storeCat[r.storeCode][cat]) storeCat[r.storeCode][cat] = {score:0,count:0};
    storeCat[r.storeCode][cat].score += sentimentScore(r.sentiment);
    storeCat[r.storeCode][cat].count++;
  });
  const storeCounts = {};
  state.rawData.forEach(r=> storeCounts[r.storeCode] = (storeCounts[r.storeCode]||0)+1);
  const topStores = Object.entries(storeCounts).map(([s,c])=>({s,c})).sort((a,b)=>b.c-a.c).slice(0,10).map(x=>x.s);
  const categories = uniq([].concat(...Object.values(storeCat).map(s=>Object.keys(s))));
  const table = document.getElementById('heatmapTable'); table.innerHTML='';
  const thead = document.createElement('thead'); const trh = document.createElement('tr'); trh.appendChild(Object.assign(document.createElement('th'),{textContent:'Store / Category'}));
  categories.forEach(cat=>{ const th = document.createElement('th'); th.textContent = cat; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  topStores.forEach(store=>{
    const tr = document.createElement('tr'); const th = document.createElement('th'); th.textContent = store; tr.appendChild(th);
    categories.forEach(cat=>{
      const td = document.createElement('td');
      const stat = storeCat[store] && storeCat[store][cat] ? storeCat[store][cat] : {score:0,count:0};
      const avg = stat.count ? stat.score / stat.count : 0;
      td.textContent = stat.count ? `${avg.toFixed(2)} (${stat.count})` : '-';
      td.style.background = stat.count ? (avg>0 ? `rgba(16,185,129,${Math.min(0.85, Math.abs(avg))})` : `rgba(239,68,68,${Math.min(0.85, Math.abs(avg))})`) : 'transparent';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
}

/* comments */
function renderComments(){
  const data = state.data.map(r=> ({...r, parsedDate: new Date(r.commentDate)})).sort((a,b)=> b.parsedDate - a.parsedDate);
  const positives = data.filter(r=> r.sentiment==='Positive').slice(0,15);
  const negatives = data.filter(r=> r.sentiment==='Negative').slice(0,15);
  const posWrap = document.getElementById('positiveComments'); posWrap.innerHTML='';
  positives.forEach(r=>{
    const card = document.createElement('div'); card.className='comment-card';
    card.innerHTML = `<div style="font-size:14px"><span style="margin-right:8px">ðŸ˜Š</span><b>${esc(r.comment || r.__raw.responseType || '')}</b></div><div class="muted" style="margin-top:6px">Store: ${esc(r.storeCode)} | Date: ${formatDate(r.commentDate)}</div>`;
    posWrap.appendChild(card);
  });
  const negWrap = document.getElementById('negativeComments'); negWrap.innerHTML='';
  negatives.forEach(r=>{
    const card = document.createElement('div'); card.className='comment-card';
    card.innerHTML = `<div style="font-size:14px"><span style="margin-right:8px">ðŸ˜ </span><b>${esc(r.comment || r.__raw.responseType || '')}</b></div><div class="muted" style="margin-top:6px">Store: ${esc(r.storeCode)} | Date: ${formatDate(r.commentDate)}</div>`;
    negWrap.appendChild(card);
  });
}

/* zone chart simple bars */
function renderZoneChart(){
  const zoneMap = {};
  state.data.forEach(r=>{ if(!zoneMap[r.zone]) zoneMap[r.zone] = {sum:0,count:0}; zoneMap[r.zone].sum += sentimentScore(r.sentiment); zoneMap[r.zone].count++; });
  const arr = Object.entries(zoneMap).map(([z,v])=>({z,avg: v.count ? v.sum/v.count : 0, count:v.count})).sort((a,b)=>b.count-a.count);
  const chart = document.getElementById('zoneChart'); chart.innerHTML='';
  const width = chart.clientWidth || 380; const height = 180; const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('width','100%'); svg.setAttribute('height',height); svg.setAttribute('viewBox',`0 0 ${width} ${height}`);
  const padding = 20;
  const maxCount = Math.max(...arr.map(a=>a.count),1);
  arr.forEach((a,i)=>{
    const bw = (width - padding*2) / Math.max(1,arr.length);
    const barH = (a.count / maxCount) * (height - 60);
    const x = padding + i*bw + 8;
    const y = height - 30 - barH;
    const rect = document.createElementNS(svgNS,'rect'); rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width', Math.max(40,bw-16)); rect.setAttribute('height',barH); rect.setAttribute('rx',10); rect.setAttribute('fill',SENT_COLORS.Positive);
    svg.appendChild(rect);
    const label = document.createElementNS(svgNS,'text'); label.setAttribute('x', x + Math.max(20,(bw-16)/2)); label.setAttribute('y', height-8); label.setAttribute('font-size','12'); label.setAttribute('text-anchor','middle'); label.textContent = a.z;
    svg.appendChild(label);
  });
  chart.appendChild(svg);
}

/* ========== Utilities ========== */
function downloadFilteredCSV(){
  if(!state.data.length) return alert('No data to download.');
  const cols = ['storeCode','businessName','zone','state','city','mallType','fy','quarter','month','rating','sentiment','commentDate','comment'];
  const header = cols.join(',');
  const lines = state.data.map(r=> cols.map(c=> `"${String(r[c]||'').replace(/"/g,'""')}"`).join(','));
  const csv = [header].concat(lines).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'voc_filtered.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* Render everything */
function renderEverything(){
  applyFilters();
  renderKPIsAndInsights();
  renderDriversChart();
  renderSentimentPie();
  renderWordCloud();
  renderLineChart();
  renderHeatmap();
  renderZoneChart();
  renderComments();
}

/* ========== UI wiring ========== */
document.getElementById('openDrawer').addEventListener('click', ()=>{
  document.getElementById('drawer').classList.add('open');
  document.body.classList.add('drawer-open');
});
document.getElementById('closeDrawer').addEventListener('click', ()=>{
  document.getElementById('drawer').classList.remove('open');
  document.body.classList.remove('drawer-open');
});
document.getElementById('applyFilters').addEventListener('click', ()=>{
  renderEverything();
  // auto close on desktop
  if(window.innerWidth > 1100){
    document.getElementById('drawer').classList.remove('open');
    document.body.classList.remove('drawer-open');
  }
});
document.getElementById('resetFilters').addEventListener('click', ()=>{
  state.filters = { businessName:null, zones:new Set(), states:new Set(), cities:new Set(), stores:new Set(), mallTypes:new Set(), sentiments:new Set(), fys:new Set(), quarters:new Set(), months:new Set() };
  renderFilterControls();
  renderEverything();
});
document.getElementById('downloadCsvBtn').addEventListener('click', downloadFilteredCSV);
document.getElementById('resetFiltersHeader').addEventListener('click', ()=>{
  state.filters = { businessName:null, zones:new Set(), states:new Set(), cities:new Set(), stores:new Set(), mallTypes:new Set(), sentiments:new Set(), fys:new Set(), quarters:new Set(), months:new Set() };
  renderFilterControls();
  renderEverything();
});

document.addEventListener('click', (e)=>{
  if(e.target && e.target.matches && e.target.matches('.pill')) {
    // noop for now
  }
});

/* ========== Init ========== */
(async function init(){
  const raw = await loadReviewData();
  state.rawData = raw.map(r=> normalizeRecord(r));
  refreshDerivedLists(state.rawData);
  // set sensible defaults
  if(state.derived.fys.length) state.filters.fys.add(state.derived.fys[0]);
  if(state.derived.businessNames.length) state.filters.businessName = state.derived.businessNames[0];
  renderFilterControls();
  renderEverything();
})();
</script>

</body>
</html>
