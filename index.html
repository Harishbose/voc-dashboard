<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CX â€“ Voice of Customer Dashboard</title>

  <!-- libs (CDN for demo) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Roboto', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    .kpi-box { min-height:120px; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:14px; box-shadow:0 10px 20px rgba(16,24,40,0.06); }
    .kpi-title { color:#374151; font-weight:600; }
    .kpi-value { font-size:34px; font-weight:700; color:#111827; }
    /* when filter open, push the main content */
    .drawer-open .main-container { margin-left:18rem; transition:margin-left .28s ease; }
    @media (max-width:900px){ .drawer-open .main-container { margin-left:0; } }
    .filter-drawer { width:18rem; }
    .card { background:white; border-radius:12px; padding:18px; box-shadow:0 8px 20px rgba(16,24,40,0.06); }
    .insight-card { border-radius:12px; padding:20px; background:#f3f7fb; }
    /* consistent KPI widths */
    .kpi-grid > div { min-width:220px; }
  </style>
</head>
<body class="bg-gray-100">

<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;
const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend, LineChart, Line } = Recharts;

/* -------------------------
   Embedded CSV (sample from your messages)
   Replace this string with fetch or file input in future.
   ------------------------- */
const csvData = `Store Name,Mall/HS,Brand,Zone,City,State,Comment Date,Month,Quarter,Financial Year,Google Rating,Sentiment,Customer Response
AJM,High-Street,Mochi,West,Ajmer,Rajasthan,4/1/2022,APR,Q1,FY2022-2023,5,Positive,Good quality
CBQ,High-Street,Crocs,South,Chennai,Tamil Nadu,4/1/2022,APR,Q1,FY2022-2023,5,Positive,Collections were good.
BTM,High-Street,Mochi,North,Bhatinda,Punjab,4/2/2022,APR,Q1,FY2022-2023,5,Positive,Mochi shoes is very good
BTM,High-Street,Mochi,North,Bhatinda,Punjab,4/2/2022,APR,Q1,FY2022-2023,5,Positive,Helping all workers.
PGQ,High-Street,Crocs,West,Pune,Maharashtra,4/2/2022,APR,Q1,FY2022-2023,5,Positive,Wow! Good service good staff good knowledge. Keep it up
GIQ,High-Street,Crocs,West,Gandhidam,Gujarat,4/2/2022,APR,Q1,FY2022-2023,5,Positive,Excellent In Quality
MSM,High-Street,Mochi,South,Chennai,Tamil Nadu,4/3/2022,APR,Q1,FY2022-2023,5,Positive,New collections are available
`;

/* Helper: load file data (for now returns embedded csv) */
function loadFileData() {
  // If you want to fetch a remote CSV, replace this logic with fetch('/path/to/file.csv').then(r=>r.text())
  return Promise.resolve(csvData);
}

/* Basic classifiers (kept from original) */
function classifyImprovementCategory(comment = '') {
  const s = comment.toLowerCase();
  if (!s) return 'Other';
  if (/(material|quality|damage|durability|defect|faulty|comfort|tear|broken|product)/.test(s)) return 'Product Quality';
  if (/(staff|service|rude|attitude|courteous|salesman|sales)/.test(s)) return 'Staff Behaviour';
  if (/(price|discount|expensive|cost|overcharged)/.test(s)) return 'Pricing & Discounts';
  if (/(collection|size|stock|available|inventory|variety)/.test(s)) return 'Inventory Management';
  if (/(return|refund|exchange|policy)/.test(s)) return 'Return & Refund Policies';
  if (/(support|help|assistance|responsive)/.test(s)) return 'Customer Support';
  if (/(promo|offer|loyalty|coupon|reward)/.test(s)) return 'Promotions & Offers';
  if (/(billing|payment|charge|invoice|transaction)/.test(s)) return 'Billing & Payment Issues';
  if (/(wait|queue|delay|slow|line)/.test(s)) return 'Wait Time / Queue Management';
  if (/(experience|experience)/.test(s)) return 'Store Experience';
  return 'Other';
}

function classifyEmotion(comment = '', sentiment = '') {
  const s = (comment || '').toLowerCase();
  if (sentiment === 'Positive' || sentiment === 'POSITIVE') {
    if (/(excellent|great|awesome|delighted)/.test(s)) return 'Satisfaction';
    if (/(thank|appreciate)/.test(s)) return 'Gratitude';
    if (/(happy|enjoyed)/.test(s)) return 'Happy';
    return 'Appreciation';
  } else if (sentiment === 'Negative' || sentiment === 'NEGATIVE') {
    if (/(rude|worst|poor|frustrated)/.test(s)) return 'Frustration';
    if (/(disappoint|bad)/.test(s)) return 'Disappointment';
    return 'Disappointment';
  } else {
    if (/(confused|unclear|puzzled)/.test(s)) return 'Confusion';
    return 'Neutral';
  }
}

function extractKeywords(comment='') {
  if (!comment) return [];
  const words = comment.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(w => w.length>3);
  const freq = {};
  words.forEach(w => freq[w] = (freq[w]||0)+1);
  return Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([w])=>w);
}

/* -------------------------
   Main Dashboard Component
   ------------------------- */
function Dashboard(){
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isFilterOpen, setIsFilterOpen] = useState(false);
  const [filters, setFilters] = useState({
    businessName: 'All', zone: [], state: [], city: [], storeCode: [], sentiment: []
  });

  useEffect(() => {
    setLoading(true);
    loadFileData().then(text => {
      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          const cleaned = res.data.map(row => {
            const rating = row['Google Rating'] ? Number(row['Google Rating']) : null;
            const comment = row['Customer Response'] || '';
            const sentiment = row['Sentiment'] || (rating>=4?'Positive':rating<=2?'Negative':'Neutral');
            return {
              ...row,
              'Customer Rating': rating,
              'Comment Date': row['Comment Date'],
              ImprovementCategory: classifyImprovementCategory(comment),
              Emotion: classifyEmotion(comment, sentiment),
              Keywords: extractKeywords(comment),
              Sentiment: sentiment
            };
          }).filter(r=>r['Customer Rating'] !== null);
          setData(cleaned);
          setLoading(false);
        }
      });
    });
  },[]);

  // FILTER HELPERS
  const unique = (k) => Array.from(new Set(data.map(d=>d[k] || '').filter(Boolean))).sort();

  const filterOptions = {
    businessName: ['All', ...unique('Brand')],
    zone: unique('Zone'),
    state: unique('State'),
    city: unique('City'),
    storeCode: unique('Store Name'),
    sentiment: unique('Sentiment')
  };

  function applyFilter(key, value, single=false){
    setFilters(prev => {
      const next = {...prev};
      if(key === 'businessName'){
        next.businessName = value;
      } else {
        if(single){
          next[key] = [value];
        } else {
          const existing = new Set(prev[key]);
          if(existing.has(value)) existing.delete(value); else existing.add(value);
          next[key] = Array.from(existing);
        }
      }
      return next;
    });
  }

  function resetFilters(){
    setFilters({ businessName:'All', zone:[], state:[], city:[], storeCode:[], sentiment:[] });
  }

  const filteredData = useMemo(() => {
    return data.filter(row => {
      if(filters.businessName && filters.businessName!=='All' && row.Brand !== filters.businessName) return false;
      if(filters.zone.length && !filters.zone.includes(row.Zone)) return false;
      if(filters.state.length && !filters.state.includes(row.State)) return false;
      if(filters.city.length && !filters.city.includes(row.City)) return false;
      if(filters.storeCode.length && !filters.storeCode.includes(row['Store Name'])) return false;
      if(filters.sentiment.length && !filters.sentiment.includes(row.Sentiment)) return false;
      return true;
    });
  }, [data, filters]);

  // KPIs
  const totalReviews = filteredData.length;
  const negCount = filteredData.filter(r=>r.Sentiment && r.Sentiment.toLowerCase()==='negative').length;
  const percNegative = totalReviews? ((negCount/totalReviews)*100).toFixed(1) : 0;

  // store averages + counts (for best store logic)
  const storeMap = {};
  filteredData.forEach(r=>{
    const s = r['Store Name'] || r['Store Code'] || '';
    if(!storeMap[s]) storeMap[s] = { total:0, count:0 };
    storeMap[s].total += (r['Customer Rating']||0);
    storeMap[s].count += 1;
  });

  const minReviewsForBest = 3; // <--- you can adjust
  const storeStats = Object.entries(storeMap).map(([store,{total,count}]) => ({store, avg: (total/count), count}));
  const bestStoreEntry = storeStats.filter(s=>s.count>=minReviewsForBest).sort((a,b)=>b.avg - a.avg)[0] || storeStats.sort((a,b)=>b.avg - a.avg)[0] || {store:'N/A', avg:0, count:0};
  const worstStoreEntry = storeStats.sort((a,b)=>a.avg - b.avg)[0] || {store:'N/A', avg:0, count:0};

  // Key drivers (improvement categories)
  const catCounts = {};
  filteredData.forEach(r=>{
    const c = r.ImprovementCategory || 'Other';
    catCounts[c] = (catCounts[c] || 0) + 1;
  });
  const keyDrivers = Object.entries(catCounts).map(([name, value])=>({name, value})).sort((a,b)=>b.value - a.value);

  // Sentiment donut
  const sentimentCounts = { Positive:0, Neutral:0, Negative:0 };
  filteredData.forEach(r=>{
    const s = (r.Sentiment||'Neutral');
    if(s.toLowerCase()==='positive') sentimentCounts.Positive++;
    else if(s.toLowerCase()==='negative') sentimentCounts.Negative++;
    else sentimentCounts.Neutral++;
  });
  const pieData = [
    { name:'Positive', value: sentimentCounts.Positive },
    { name:'Neutral', value: sentimentCounts.Neutral },
    { name:'Negative', value: sentimentCounts.Negative }
  ];

  // Emotion word cloud simplified (top emotions)
  const emotionCounts = {};
  filteredData.forEach(r => {
    const e = r.Emotion || 'Neutral';
    emotionCounts[e] = (emotionCounts[e]||0) + 1;
  });
  const emotionData = Object.entries(emotionCounts).map(([k,v])=>({text:k, value:v})).sort((a,b)=>b.value - a.value);

  // Trend APR -> MAY -> JUN (static months if present)
  const monthsOrder = ['APR','MAY','JUN'];
  const trendData = monthsOrder.map(m=>{
    const monthRows = filteredData.filter(r => (r.Month||'').toUpperCase() === m);
    return {
      month: m,
      Positive: monthRows.filter(r=>r.Sentiment && r.Sentiment.toLowerCase()==='positive').length,
      Neutral: monthRows.filter(r=>r.Sentiment && r.Sentiment.toLowerCase()==='neutral').length,
      Negative: monthRows.filter(r=>r.Sentiment && r.Sentiment.toLowerCase()==='negative').length
    };
  });

  // top positive/negative comments
  const positiveComments = filteredData.filter(r=>r.Sentiment && r.Sentiment.toLowerCase()==='positive').sort((a,b)=> new Date(b['Comment Date']) - new Date(a['Comment Date']));
  const negativeComments = filteredData.filter(r=>r.Sentiment && r.Sentiment.toLowerCase()==='negative').sort((a,b)=> new Date(b['Comment Date']) - new Date(a['Comment Date']));

  // strategic insights (simple derived)
  const topDriver = keyDrivers[0] || { name:'N/A', value:0 };
  const topEmotion = emotionData[0] || { text:'N/A', value:0 };

  // drawer push class on body
  useEffect(()=> {
    if(isFilterOpen) document.body.classList.add('drawer-open'); else document.body.classList.remove('drawer-open');
  },[isFilterOpen]);

  if(loading) return <div className="p-8 text-center">Loading dashboard...</div>;

  return (
    <div className="min-h-screen">
      {/* Filter Drawer */}
      <div className={`fixed top-0 left-0 z-40 h-full bg-white filter-drawer shadow-lg p-4 overflow-y-auto transform ${isFilterOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform`}>
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-2xl font-semibold text-blue-800">Filters</h3>
          <button className="bg-blue-100 px-3 py-1 rounded" onClick={()=>setIsFilterOpen(false)}>Hide</button>
        </div>

        {/* Business single-select */}
        <div className="mb-4">
          <div className="text-sm font-medium mb-2">Business Name (single-select)</div>
          {filterOptions.businessName.map(b => (
            <label key={b} className="flex items-center mb-2 cursor-pointer">
              <input type="radio" name="brand" checked={filters.businessName===b} onChange={()=>applyFilter('businessName', b)} className="mr-3" />
              <span>{b}</span>
            </label>
          ))}
        </div>

        <div className="mb-4">
          <div className="text-sm font-medium mb-2">Zone</div>
          {filterOptions.zone.map(z => (
            <label key={z} className="flex items-center mb-2">
              <input type="checkbox" checked={filters.zone.includes(z)} onChange={()=>applyFilter('zone', z)} className="mr-3" />
              <span>{z}</span>
            </label>
          ))}
        </div>

        <div className="mb-4">
          <div className="text-sm font-medium mb-2">State</div>
          <input type="text" placeholder="Search state..." className="w-full p-2 mb-2 border rounded" onChange={()=>{}}/>
          <div style={{maxHeight:220, overflowY:'auto'}}>
            {filterOptions.state.map(s => (
              <label key={s} className="flex items-center mb-2">
                <input type="checkbox" checked={filters.state.includes(s)} onChange={()=>applyFilter('state', s)} className="mr-3"/>
                <span>{s}</span>
              </label>
            ))}
          </div>
        </div>

        <div className="flex gap-2 mt-4">
          <button className="flex-1 bg-gray-200 px-3 py-2 rounded" onClick={()=>setIsFilterOpen(false)}>Apply</button>
          <button className="flex-1 bg-red-500 text-white px-3 py-2 rounded" onClick={resetFilters}>Reset Filters</button>
        </div>
      </div>

      {/* Main content */}
      <div className="main-container p-8">
        {/* Header */}
        <div className="text-center mb-6">
          <h1 className="text-3xl font-extrabold text-gray-800">Voice of Customer â€” Google Reviews</h1>
          <p className="text-sm text-gray-500">Interactive Analytics Dashboard</p>
        </div>

        {/* Buttons: show filters */}
        <div className="flex justify-between items-center mb-4">
          <div>
            <button className="bg-white px-4 py-2 rounded shadow" onClick={()=>setIsFilterOpen(true)}>Filters</button>
          </div>
          <div className="flex items-center gap-3">
            <button className="bg-white px-4 py-2 rounded shadow" onClick={()=>{ /* placeholder upload */ }}>Upload CSV</button>
            <button className="bg-white px-4 py-2 rounded shadow" onClick={()=>{
              // allow CSV download of filtered data
              const csv = Papa.unparse(filteredData);
              const blob = new Blob([csv], {type:'text/csv'});
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a'); a.href=url; a.download='filtered.csv'; a.click(); URL.revokeObjectURL(url);
            }}>Download CSV</button>
            <button className="bg-red-500 text-white px-4 py-2 rounded" onClick={resetFilters}>Reset Filters</button>
          </div>
        </div>

        {/* KPI row */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 kpi-grid mb-6">
          <div className="kpi-box card text-center">
            <div className="kpi-title">Total Reviews</div>
            <div className="kpi-value">{totalReviews}</div>
          </div>
          <div className="kpi-box card text-center">
            <div className="kpi-title">% Negative Reviews</div>
            <div className="kpi-value" style={{color:'#dc2626'}}>{percNegative}%</div>
          </div>
          <div className="kpi-box card text-center">
            <div className="kpi-title">Best Rated Store</div>
            <div className="kpi-value">{bestStoreEntry.store} ({bestStoreEntry.avg ? bestStoreEntry.avg.toFixed(2):'N/A'} â€¢ {bestStoreEntry.count})</div>
          </div>
          <div className="kpi-box card text-center">
            <div className="kpi-title">Worst Rated Store</div>
            <div className="kpi-value">{worstStoreEntry.store} ({worstStoreEntry.avg ? worstStoreEntry.avg.toFixed(2):'N/A'} â€¢ {worstStoreEntry.count})</div>
          </div>
        </div>

        {/* Strategic insights row */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div className="insight-card">
            <h3 className="font-semibold text-lg mb-2">Top Insight</h3>
            <p className="text-gray-700">Top driver: <strong>{topDriver.name}</strong> â€” mentioned in {topDriver.value} reviews.</p>
          </div>
          <div className="insight-card">
            <h3 className="font-semibold text-lg mb-2">Top Emotion</h3>
            <p className="text-gray-700">Top emotion: <strong>{topEmotion.text}</strong> â€” mentioned {topEmotion.value} time(s).</p>
          </div>
          <div className="insight-card">
            <h3 className="font-semibold text-lg mb-2">Store Experience</h3>
            <p className="text-gray-700">This was the most mentioned theme and key driver of both praise and criticism.</p>
          </div>
        </div>

        {/* Visuals row */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          {/* Key drivers small bar chart */}
          <div className="card">
            <h3 className="text-xl font-semibold mb-4">Key Drivers of Customer Feedback</h3>
            <div style={{height:220}}>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={keyDrivers.map(k=>({name:k.name, value:k.value}))} layout="vertical" margin={{left:20}}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis type="number" hide />
                  <YAxis type="category" dataKey="name" width={140} />
                  <Tooltip />
                  <Bar dataKey="value" fill="url(#grad)" radius={[10,10,10,10]}>
                    <defs>
                      <linearGradient id="grad" x1="0" x2="1">
                        <stop offset="0%" stopColor="#10b981" />
                        <stop offset="100%" stopColor="#06b6d4" />
                      </linearGradient>
                    </defs>
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
              <div className="flex justify-end mt-2 text-sm font-semibold">
                {keyDrivers.length>0 && <span className="mr-4">{keyDrivers[0].name} ({keyDrivers[0].value})</span>}
              </div>
            </div>
          </div>

          {/* Sentiment donut */}
          <div className="card">
            <h3 className="text-xl font-semibold mb-4">Sentiment Distribution</h3>
            <div style={{height:240}}>
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie data={pieData} dataKey="value" innerRadius={50} outerRadius={80} paddingAngle={3} labelLine={false}>
                    {pieData.map((entry, index)=>(
                      <Cell key={index} fill={entry.name==='Positive' ? '#10b981' : entry.name==='Negative' ? '#ef4444' : '#f59e0b'} />
                    ))}
                  </Pie>
                  <Legend layout="vertical" verticalAlign="bottom" align="left" />
                </PieChart>
              </ResponsiveContainer>
              <div className="mt-2 text-sm">
                <div><span className="inline-block w-3 h-3 bg-green-500 mr-2"></span><strong>POSITIVE</strong> {pieData[0].value} ({pieData[0].value===0?0:((pieData[0].value/Math.max(1,totalReviews))*100).toFixed(1)}%)</div>
                <div><span className="inline-block w-3 h-3 bg-yellow-500 mr-2"></span><strong>NEUTRAL</strong> {pieData[1].value}</div>
                <div><span className="inline-block w-3 h-3 bg-red-500 mr-2"></span><strong>NEGATIVE</strong> {pieData[2].value}</div>
              </div>
            </div>
          </div>

          {/* Trend chart */}
          <div className="card">
            <h3 className="text-xl font-semibold mb-4">Sentiment Trend over Time (APR â†’ MAY â†’ JUN)</h3>
            <div style={{height:240}}>
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={trendData} margin={{left:0}}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="month" />
                  <YAxis />
                  <Tooltip />
                  <Line type="monotone" dataKey="Positive" stroke="#10b981" strokeWidth={2} dot={{r:4}}/>
                  <Line type="monotone" dataKey="Negative" stroke="#ef4444" strokeWidth={2} dot={{r:4}}/>
                  <Line type="monotone" dataKey="Neutral" stroke="#f59e0b" strokeWidth={2} dot={{r:4}}/>
                </LineChart>
              </ResponsiveContainer>
              <div className="text-center mt-2 text-sm text-gray-500">APR â€” MAY â€” JUN (static)</div>
            </div>
          </div>
        </div>

        {/* Word cloud + comments */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div className="card">
            <h3 className="text-xl font-semibold mb-4">Emotion Word Cloud</h3>
            <div className="flex flex-wrap gap-4 items-start" style={{minHeight:180}}>
              {emotionData.length ? emotionData.map(e=>(
                <div key={e.text} style={{background:'#10b981', color:'white', padding:'10px 22px', borderRadius:999, fontSize: Math.min(28, 12 + e.value*3)}}>
                  {e.text} ({e.value})
                </div>
              )) : <div className="text-gray-500">No emotions</div>}
            </div>
          </div>

          <div className="card col-span-2">
            <h3 className="text-xl font-semibold mb-4">Comments</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h4 className="font-semibold mb-2">Positive Comments (Top 15)</h4>
                <div style={{maxHeight:280, overflowY:'auto'}}>
                  {positiveComments.length ? positiveComments.slice(0,15).map((r,i)=>(
                    <div key={i} className="mb-3 p-3 rounded border border-gray-100 bg-gray-50">
                      <div className="font-semibold text-lg">ðŸ˜Š {r['Customer Response']}</div>
                      <div className="text-sm text-gray-500 mt-1">Store: {r['Store Name']} | Date: {r['Comment Date']}</div>
                    </div>
                  )) : <div className="text-gray-500">No positive comments.</div>}
                </div>
              </div>

              <div>
                <h4 className="font-semibold mb-2">Negative Comments (Top 15)</h4>
                <div style={{maxHeight:280, overflowY:'auto'}}>
                  {negativeComments.length ? negativeComments.slice(0,15).map((r,i)=>(
                    <div key={i} className="mb-3 p-3 rounded border border-gray-100 bg-gray-50">
                      <div className="font-semibold text-lg">ðŸ˜  {r['Customer Response']}</div>
                      <div className="text-sm text-gray-500 mt-1">Store: {r['Store Name']} | Date: {r['Comment Date']}</div>
                    </div>
                  )) : <div className="text-gray-500">No negative comments.</div>}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="mb-12 text-center text-gray-400">Dashboard built from your provided CSV sample. Replace CSV with your live data for production.</div>
      </div>
    </div>
  );
}

/* Render */
ReactDOM.createRoot(document.getElementById('root')).render(<Dashboard/>);
</script>
</body>
</html>
