<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voice of Customer â€” Google Reviews Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f3f4f6;
  --card:#ffffff;
  --muted:#6b7280;
  --shadow: 0 6px 18px rgba(15,23,42,0.06);
  --accent-gold: #b8860b; /* warm gold */
  --accent-rose: #d48a8a; /* subtle rose if needed */
  --positive: #10b981;
  --negative: #ef4444;
  --neutral: #f59e0b;
  font-family: Roboto, system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial;
  color: #0b1220;
}

/* Page */
html,body{height:100%; margin:0; background:var(--bg); -webkit-font-smoothing:antialiased;}
.container{max-width:1200px; margin:18px auto; padding:18px; box-sizing:border-box;}

/* Header */
.header {
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; margin-bottom:14px;
}
.brand {
  flex:1; text-align:center;
}
.title { font-weight:700; font-size:22px; margin:2px 0; letter-spacing:0.2px; color:#0b1220; }
.subtitle { font-size:13px; color:var(--muted); margin-top:4px; }

/* Filter button top-left */
.left-controls { display:flex; align-items:center; gap:10px; width:220px; }
.filter-btn {
  background:var(--card); border-radius:8px; padding:9px 12px; border:1px solid rgba(2,6,23,0.06);
  cursor:pointer; box-shadow:var(--shadow); display:inline-flex; align-items:center; gap:8px;
}
.filter-btn b{font-weight:600; color:#0b1220;}
.header-accent { height:8px; border-radius:8px; background: linear-gradient(90deg, rgba(184,134,11,0.15), rgba(212,138,138,0.08)); margin-bottom:16px; }

/* KPI row */
.kpi-row { display:flex; gap:14px; align-items:center; justify-content:flex-start; margin-bottom:18px; flex-wrap:wrap; }
.kpi { min-width:220px; background:var(--card); border-radius:12px; padding:18px; box-shadow:var(--shadow); }
.kpi .label{font-size:14px; color:var(--muted); margin-bottom:8px}
.kpi .value{font-size:26px; font-weight:700; color:#0b1220}

/* controls right of header (download CSV) */
.right-controls { display:flex; gap:8px; align-items:center; }

/* Layout grid */
.main-grid { display:grid; grid-template-columns: 1fr 360px; gap:16px; align-items:start; }
.left-col { display:flex; flex-direction:column; gap:16px; }
.right-col { display:flex; flex-direction:column; gap:16px; }

/* Cards */
.card { background:var(--card); border-radius:12px; padding:16px; box-shadow:var(--shadow); overflow:hidden; }
.card h3{ margin:0 0 12px 0; font-size:18px; color:#0b1220 }
.pills {display:flex; gap:8px; flex-wrap:wrap}

/* Charts placeholders */
.svg-chart{ width:100%; height:220px }

/* Word cloud */
.word-cloud { min-height:140px; display:flex; flex-wrap:wrap; gap:8px; align-items:flex-start; }

/* Heatmap table */
.heatmap-wrap{ overflow:auto; border-radius:8px; padding:8px; background:linear-gradient(180deg,#fff,#fbfdff) }
.heatmap-table{ border-collapse:collapse; width:100% }
.heatmap-table th, .heatmap-table td{ padding:8px 10px; border:1px solid rgba(2,6,23,0.06); white-space:nowrap; font-size:13px }
.heatmap-table th{ background:#fff; position:sticky; top:0 }

/* comments */
.comments-row { display:flex; gap:12px; }
.comment-column { flex:1; max-height:360px; overflow:auto; }
.comment-card { background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:8px; border:1px solid rgba(2,6,23,0.04) }

/* strategic insights grid */
.insights { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:6px; }
.insight-card{ border-radius:12px; padding:14px; min-height:120px; box-shadow:var(--shadow); background:#fff; }

/* drawer (popout left) */
.drawer-backdrop{ position:fixed; inset:0; display:none; align-items:flex-start; justify-content:flex-start; z-index:9998; }
.drawer { width:360px; max-width:92vw; height:100vh; background:var(--card); box-shadow: 12px 0 40px rgba(2,6,23,0.15); padding:14px; overflow:auto; border-right:6px solid rgba(184,134,11,0.09); }
.drawer .close { display:flex; justify-content:flex-end; margin-bottom:8px }
.collapsible { border-radius:8px; background:#fafafa; padding:8px; margin-bottom:10px; border:1px solid rgba(2,6,23,0.03) }
.collapsible h4 { margin:0; cursor:pointer; font-size:14px; }
.collapsible .content { margin-top:8px; max-height:240px; overflow:auto; padding-right:6px; }

/* small helpers & buttons */
.btn { padding:8px 12px; border-radius:8px; border:1px solid rgba(2,6,23,0.06); background:var(--card); cursor:pointer; }
.btn.primary { background:var(--accent-gold); color:#fff; border:none; }
.search-input{ width:100%; padding:8px; border-radius:8px; border:1px solid rgba(2,6,23,0.06) }

/* responsive */
@media (max-width:1100px){
  .main-grid { grid-template-columns: 1fr; }
  .insights{ grid-template-columns: repeat(2,1fr); }
  .kpi-row{ justify-content:center; }
}
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <div class="left-controls">
      <button id="openFilters" class="filter-btn" title="Open Filters">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 5h18M6 12h12M10 19h4" stroke="#0b1220" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <b>Filters</b>
      </button>
    </div>

    <div class="brand">
      <div class="title">Voice of Customer â€” Google Reviews</div>
      <div class="subtitle">Interactive Analytics Dashboard</div>
    </div>

    <div class="right-controls">
      <button id="downloadCsvBtn" class="btn">Download CSV</button>
    </div>
  </div>

  <div class="header-accent" aria-hidden="true"></div>

  <!-- KPIs -->
  <div class="kpi-row">
    <div class="kpi">
      <div class="label">Total Reviews</div>
      <div class="value" id="kpiTotal">0</div>
    </div>
    <div class="kpi">
      <div class="label">% Negative Reviews</div>
      <div class="value" id="kpiNegative">0%</div>
    </div>
    <div class="kpi">
      <div class="label">Best Store</div>
      <div class="value" id="kpiBest">â€”</div>
    </div>
    <div class="kpi">
      <div class="label">Lowest Rated Store</div>
      <div class="value" id="kpiWorst">â€”</div>
    </div>
  </div>

  <!-- Strategic Insights heading -->
  <h3 style="margin:18px 0 8px 0; color:#0b1220">Strategic Insights</h3>
  <div id="insightsGrid" class="insights"></div>

  <!-- Main content -->
  <div class="main-grid" style="margin-top:14px;">
    <div class="left-col">
      <div class="card">
        <h3>Key Drivers of Customer Feedback</h3>
        <div class="pills" id="driverPills"></div>
        <div id="driversChart" class="svg-chart"></div>
      </div>

      <div class="card">
        <h3>Emotion Word Cloud</h3>
        <div class="word-cloud" id="wordCloud"></div>
      </div>

      <div class="card">
        <h3>Store Sentiment Heatmap (Top stores Ã— Categories)</h3>
        <div id="heatmapWrap" class="heatmap-wrap" style="margin-top:8px">
          <table id="heatmapTable" class="heatmap-table"></table>
        </div>
      </div>

      <div class="card">
        <h3>Positive Comments (Top 15) â€” By Date</h3>
        <div id="positiveComments" class="comment-column"></div>
      </div>
    </div>

    <div class="right-col">
      <div class="card">
        <h3>Sentiment Distribution</h3>
        <div id="pieChart" style="width:100%;height:220px;display:flex;align-items:center;justify-content:center"></div>
        <div id="pieLegend" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Sentiment Trend Over Time (APR â†’ MAR)</h3>
        <div id="lineChart" class="svg-chart"></div>
      </div>

      <div class="card">
        <h3>Sentiment by Zone</h3>
        <div id="zoneChart" class="svg-chart"></div>
      </div>

      <div class="card">
        <h3>Negative Comments (Top 15) â€” By Date</h3>
        <div id="negativeComments" class="comment-column"></div>
      </div>
    </div>
  </div>
</div>

<!-- Drawer -->
<div id="drawerBackdrop" class="drawer-backdrop">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="Filters drawer">
    <div class="close"><button id="closeDrawer" class="btn">Close</button></div>

    <div class="collapsible">
      <h4 data-toggle="business">Business Name</h4>
      <div class="content" id="businessNameWrap"></div>
    </div>

    <div class="collapsible">
      <h4 data-toggle="zone">Zone</h4>
      <div class="content" id="zoneWrap"></div>
    </div>

    <div class="collapsible">
      <h4 data-toggle="state">State</h4>
      <div class="content">
        <input id="stateSearch" class="search-input" placeholder="Search state..." />
        <div id="stateWrap" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="collapsible">
      <h4 data-toggle="city">City</h4>
      <div class="content">
        <input id="citySearch" class="search-input" placeholder="Search city..." />
        <div id="cityWrap" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="collapsible">
      <h4 data-toggle="store">Store</h4>
      <div class="content">
        <input id="storeSearch" class="search-input" placeholder="Search store..." />
        <div id="storeWrap" style="margin-top:8px"></div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="applyFilters" class="btn primary">Apply Filters</button>
      <button id="resetFilters" class="btn">Reset</button>
    </div>
  </div>
</div>

<script>
/* ------------- Config ------------- */
const API_URLS = ["https://raw.githubusercontent.com/Harishbose/voc-dashboard/main/reviews.json"];
const MONTH_ORDER = ['APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC','JAN','FEB','MAR'];
const SENTIMENT_COLORS = { Positive: '#10b981', Negative: '#ef4444', Neutral: '#f59e0b' };

let state = {
  rawData: [], data: [],
  filters: { businessName:null, zones:new Set(), states:new Set(), cities:new Set(), stores:new Set() },
  derived: {}
};

/* ------------- Helpers ------------- */
function escapeHtml(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function sentimentScore(sent){ if(sent==='Positive') return 1; if(sent==='Negative') return -1; return 0; }
function classifyImprovementCategory(text){
  if(!text) return 'Miscellaneous';
  const t = text.toLowerCase();
  const matches = arr => arr.some(k => t.includes(k));
  if(matches(['staff','service','salesman','experience','assistance','interaction'])) return 'Store Experience';
  if(matches(['quality','material','product','durability','defect','faulty'])) return 'Product Quality';
  if(matches(['collection','variety','size','available','stock','availability'])) return 'Inventory Management';
  if(matches(['price','cost','expensive','discount','deal','value'])) return 'Pricing & Discounts';
  if(matches(['return','exchange','refund','policy','returnable'])) return 'Return & Refund Policies';
  if(matches(['support','help','assistance','responsive','query','resolution'])) return 'Customer Support';
  if(matches(['promotion','offer','loyalty','deal','coupon','reward'])) return 'Promotions & Offers';
  if(matches(['billing','payment','charge','invoice','transaction'])) return 'Billing & Payment Issues';
  if(matches(['behaviour','rude','polite','attitude','courtesy','professionalism'])) return 'Staff Behaviour';
  if(matches(['wait','queue','delay','slow','line','turnaround'])) return 'Wait Time / Queue Management';
  return 'Miscellaneous';
}

/* Normalize */
function normalizeRecord(r){
  const rec = {};
  rec.rating = (r.rating !== undefined && r.rating !== null && !isNaN(Number(r.rating))) ? Number(r.rating) : 0;
  rec.storeCode = r.storeCode || r['storeCode'] || r['Store Name'] || r['store'] || '';
  rec.mallType = r.mallType || r['mallType'] || '';
  rec.businessName = r.businessName || r['Brand'] || '';
  rec.zone = r.zone || '';
  rec.state = r.state || '';
  rec.city = r.city || '';
  rec.commentDate = r.commentDate || r['commentDate'] || '';
  rec.month = (r.month || r['month'] || '').toString().toUpperCase();
  rec.quarter = r.quarter || '';
  rec.fy = r.fy || '';
  rec.sentiment = (r.sentiment || 'Neutral').toString();
  let commentText = r.comment || r['comment'] || r.responseType || r['Customer Response'] || '';
  rec.comment = commentText || '';
  rec.__raw = r;
  return rec;
}

/* Fetch */
async function loadReviewData(){
  for(const url of API_URLS){
    try {
      const res = await fetch(url);
      if(!res.ok) continue;
      const data = await res.json();
      if(Array.isArray(data)) return data;
    } catch(e){}
  }
  alert('Could not load data from backend (reviews.json).');
  return [];
}

/* Derived lists */
function refreshDerivedLists(all){
  state.derived.businessNames = uniq(all.map(r=>r.businessName));
  state.derived.zones = uniq(all.map(r=>r.zone));
  state.derived.states = uniq(all.map(r=>r.state));
  state.derived.cities = uniq(all.map(r=>r.city));
  state.derived.stores = uniq(all.map(r=>r.storeCode));
}
function uniq(arr){ return Array.from(new Set(arr.filter(x=>x && x!==null))).sort(); }

/* Cascade allowed - not strictly necessary but we'll use allowed lists */
function cascadeAllowed(){
  const base=state.rawData; const f=state.filters;
  const allowedStates=new Set(), allowedCities=new Set(), allowedStores=new Set();
  base.forEach(r=> { if(f.zones.size===0 || f.zones.has(r.zone)) allowedStates.add(r.state); });
  base.forEach(r=> { if((f.zones.size===0 || f.zones.has(r.zone)) && (f.states.size===0 || f.states.has(r.state))) allowedCities.add(r.city); });
  base.forEach(r=> { if((f.zones.size===0||f.zones.has(r.zone)) && (f.states.size===0||f.states.has(r.state)) && (f.cities.size===0||f.cities.has(r.city))) allowedStores.add(r.storeCode); });
  state.derived.allowedStates = Array.from(allowedStates).sort();
  state.derived.allowedCities = Array.from(allowedCities).sort();
  state.derived.allowedStores = Array.from(allowedStores).sort();
}

/* Apply filters */
function applyFilters(){
  const f = state.filters;
  let data = state.rawData.slice();
  if(f.businessName) data = data.filter(r=> r.businessName === f.businessName);
  if(f.zones.size) data = data.filter(r=> f.zones.has(r.zone));
  if(f.states.size) data = data.filter(r=> f.states.has(r.state));
  if(f.cities.size) data = data.filter(r=> f.cities.has(r.city));
  if(f.stores.size) data = data.filter(r=> f.stores.has(r.storeCode));
  state.data = data;
}

/* Render filter UI in the drawer */
function renderFilterControls(){
  cascadeAllowed();
  // business names (radio)
  const bwrap = document.getElementById('businessNameWrap'); bwrap.innerHTML='';
  state.derived.businessNames.forEach(name=>{
    const div = document.createElement('div');
    const checked = state.filters.businessName === name ? 'checked' : '';
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="radio" name="businessName" ${checked} value="${escapeHtml(name)}"> ${escapeHtml(name)}</label>`;
    bwrap.appendChild(div);
  });
  // zones
  const zwrap = document.getElementById('zoneWrap'); zwrap.innerHTML='';
  state.derived.zones.forEach(z=>{
    const div = document.createElement('div');
    const checked = state.filters.zones.has(z) ? 'checked' : '';
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${escapeHtml(z)}" class="zone-checkbox" ${checked}/> ${escapeHtml(z)}</label>`;
    zwrap.appendChild(div);
  });

  // states
  const swrap = document.getElementById('stateWrap'); swrap.innerHTML='';
  (state.derived.allowedStates || state.derived.states).forEach(s=>{
    const checked = state.filters.states.has(s) ? 'checked' : '';
    const div = document.createElement('div');
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${escapeHtml(s)}" class="state-checkbox" ${checked}/> ${escapeHtml(s)}</label>`;
    swrap.appendChild(div);
  });

  // cities
  const cwrap = document.getElementById('cityWrap'); cwrap.innerHTML='';
  (state.derived.allowedCities || state.derived.cities).forEach(c=>{
    const checked = state.filters.cities.has(c) ? 'checked' : '';
    const div = document.createElement('div');
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${escapeHtml(c)}" class="city-checkbox" ${checked}/> ${escapeHtml(c)}</label>`;
    cwrap.appendChild(div);
  });

  // stores
  const stwrap = document.getElementById('storeWrap'); stwrap.innerHTML='';
  (state.derived.allowedStores || state.derived.stores).forEach(s=>{
    const checked = state.filters.stores.has(s) ? 'checked' : '';
    const div = document.createElement('div');
    div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-val="${escapeHtml(s)}" class="store-checkbox" ${checked}/> ${escapeHtml(s)}</label>`;
    stwrap.appendChild(div);
  });

  attachFilterListeners();
}

/* attach filter listeners */
function attachFilterListeners(){
  document.querySelectorAll('input[name="businessName"]').forEach(r=>{
    r.addEventListener('change', e=>{
      state.filters.businessName = e.target.value;
    });
  });

  document.querySelectorAll('.zone-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const val = e.target.dataset.val;
      if(e.target.checked) state.filters.zones.add(val); else state.filters.zones.delete(val);
      renderFilterControls();
    });
  });
  document.querySelectorAll('.state-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const val = e.target.dataset.val;
      if(e.target.checked) state.filters.states.add(val); else state.filters.states.delete(val);
      renderFilterControls();
    });
  });
  document.querySelectorAll('.city-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const val = e.target.dataset.val;
      if(e.target.checked) state.filters.cities.add(val); else state.filters.cities.delete(val);
      renderFilterControls();
    });
  });
  document.querySelectorAll('.store-checkbox').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const val = e.target.dataset.val;
      if(e.target.checked) state.filters.stores.add(val); else state.filters.stores.delete(val);
      renderFilterControls();
    });
  });

  document.getElementById('stateSearch').addEventListener('input', e=>{
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('#stateWrap > div').forEach(div=>{
      div.style.display = div.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
  document.getElementById('citySearch').addEventListener('input', e=>{
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('#cityWrap > div').forEach(div=>{
      div.style.display = div.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
  document.getElementById('storeSearch')?.addEventListener('input', e=>{
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('#storeWrap > div').forEach(div=>{
      div.style.display = div.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
}

/* KPI and insights */
function renderKPIsAndInsights(){
  applyFilters();
  const data = state.data || [];
  const total = data.length;
  const negatives = data.filter(d=>d.sentiment==='Negative').length;
  const negPct = total ? ((negatives/total)*100).toFixed(1) + '%' : '0%';
  document.getElementById('kpiTotal').textContent = total;
  document.getElementById('kpiNegative').textContent = negPct;

  // Best/Worst store using weighted score
  const storeMap = {};
  state.rawData.forEach(r=>{
    if(!storeMap[r.storeCode]) storeMap[r.storeCode] = {sum:0,count:0};
    storeMap[r.storeCode].sum += Number(r.rating||0);
    storeMap[r.storeCode].count++;
  });
  const storeScores = Object.entries(storeMap).map(([s,v])=>{
    const avg = v.count ? (v.sum / v.count) : 0;
    const weighted = avg * Math.log(1 + v.count);
    return {store:s, avg, count:v.count, weighted};
  }).filter(x=>x.store && x.store.trim() !== '');

  if(storeScores.length){
    // choose best by highest weighted, worst by lowest weighted
    const best = storeScores.slice().sort((a,b)=>b.weighted - a.weighted)[0];
    const worst = storeScores.slice().sort((a,b)=>a.weighted - b.weighted)[0];
    document.getElementById('kpiBest').textContent = best ? `${best.store} (${best.avg.toFixed(2)})` : 'â€”';
    document.getElementById('kpiWorst').textContent = worst ? `${worst.store} (${worst.avg.toFixed(2)})` : 'â€”';
  } else {
    document.getElementById('kpiBest').textContent = 'â€”';
    document.getElementById('kpiWorst').textContent = 'â€”';
  }

  // Strategic Insights
  const grid = document.getElementById('insightsGrid'); grid.innerHTML='';
  const strategic = generateStrategicInsights(state.data);
  strategic.forEach(s=>{
    const el = document.createElement('div'); el.className='insight-card';
    el.innerHTML = `<h4 style="margin-top:0">${escapeHtml(s.headline)}</h4><p style="color:var(--muted);">${escapeHtml(s.description)}</p>`;
    grid.appendChild(el);
  });
}

/* Generate strategic insights (heuristic) */
function generateStrategicInsights(data){
  data = data || [];
  const categories = {};
  data.forEach(r=>{ const cat = classifyImprovementCategory(r.comment); if(cat==='Miscellaneous') return; categories[cat] = (categories[cat]||0)+1; });
  const total = Object.values(categories).reduce((a,b)=>a+b,0) || 1;
  const sortedCats = Object.entries(categories).map(([k,v])=>({k,v,percent:(v/total*100)})).sort((a,b)=>b.v-a.v);
  const theme = sortedCats[0] ? sortedCats[0].k : 'Store Experience';
  const themePct = sortedCats[0] ? Math.round(sortedCats[0].percent) : 0;

  // zone dip
  const zoneStats = {};
  data.forEach(r=>{ if(!zoneStats[r.zone]) zoneStats[r.zone] = {sum:0,count:0,neg:0}; zoneStats[r.zone].sum += r.rating; zoneStats[r.zone].count++; if(r.sentiment==='Negative') zoneStats[r.zone].neg++; });
  const zoneArr = Object.entries(zoneStats).map(([z,v])=>({zone:z,avg:v.count? v.sum/v.count:0, negPct:v.count? (v.neg/v.count*100):0})).sort((a,b)=>b.negPct-a.negPct);
  const topZone = zoneArr[0] || {zone:'N/A',avg:0,negPct:0};

  // underperformers by avg <=4
  const storeMap = {};
  data.forEach(r=>{ if(!storeMap[r.storeCode]) storeMap[r.storeCode] = {sum:0,count:0,neg:0}; storeMap[r.storeCode].sum += r.rating; storeMap[r.storeCode].count++; if(r.sentiment==='Negative') storeMap[r.storeCode].neg++; });
  const underperformers = Object.entries(storeMap).map(([s,v])=>({s,avg:v.sum/v.count, count:v.count, negPct:v.count? v.neg/v.count*100:0})).filter(x=>x.avg<=4).sort((a,b)=>a.avg-b.avg).slice(0,5).map(x=>x.s);
  const underperformingText = underperformers.length ? underperformers.join(', ') : 'N/A';

  // pos momentum
  function daysAgo(d,n){ const D=new Date(d); D.setDate(D.getDate()-n); return D; }
  const today = new Date();
  const last30 = data.filter(r=> new Date(r.commentDate) >= daysAgo(today,30));
  const prev30 = data.filter(r=> new Date(r.commentDate) < daysAgo(today,30) && new Date(r.commentDate) >= daysAgo(today,60));
  const posLast = last30.filter(r=>r.sentiment==='Positive').length;
  const posPrev = prev30.filter(r=>r.sentiment==='Positive').length;
  const posPctChange = posPrev ? Math.round(((posLast-posPrev)/posPrev)*100) : (posLast? 100: 0);

  const cityMap = {}; data.forEach(r=> cityMap[r.city] = (cityMap[r.city]||0)+1);
  const topCities = Object.entries(cityMap).map(([c,v])=>({c,v})).sort((a,b)=>b.v-a.v).slice(0,3).map(x=>x.c).join(', ') || 'N/A';

  return [
    {headline:'Store Experience Dominates', description:`This was the most mentioned theme, appearing in ${themePct}% of customer feedback.`},
    {headline:`${topZone.zone} Zone Sentiment Dip`, description:`Average rating ${topZone.avg.toFixed(1)}, driven by negative in-store experience.`},
    {headline:'Stores needing Attention', description:`Stores with low average ratings: ${underperformingText}`},
    {headline:'Uptick in Positive Feedback', description:`Positive reviews changed by ${posPctChange}% in last 30 days.`},
    {headline:`Top Cities`, description:`High review volumes in ${topCities}.`},
    {headline:'Best Performing Stores', description:`Best-performing stores identified using weighted score (avg Ã— log(1+count)).`}
  ];
}

/* Drivers chart (bar-like) */
function renderDriversChart(){
  const categories = {};
  state.data.forEach(r=>{
    const cat = classifyImprovementCategory(r.comment);
    if(cat==='Miscellaneous') return;
    categories[cat] = (categories[cat]||0)+1;
  });
  const arr = Object.entries(categories).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
  const total = arr.reduce((a,b)=>a+b.v,0) || 1;
  let others=0;
  const filtered = arr.filter(item=> {
    if(item.v/total < 0.05){ others += item.v; return false; }
    return true;
  });
  if(others) filtered.push({k:'Miscellaneous/Others', v:others});
  filtered.sort((a,b)=>b.v-a.v);

  // pills
  const pillWrap = document.getElementById('driverPills'); pillWrap.innerHTML='';
  filtered.forEach(item=>{
    const pill = document.createElement('div'); pill.style.padding='8px 10px'; pill.style.borderRadius='999px'; pill.style.background='#f1f5f9';
    pill.style.fontWeight='600'; pill.style.cursor='default'; pill.textContent = `${item.k} (${item.v})`;
    pillWrap.appendChild(pill);
  });

  // svg bars
  const chart = document.getElementById('driversChart'); chart.innerHTML='';
  const width = chart.clientWidth || 760, height = Math.max(80, filtered.length*36);
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('width','100%'); svg.setAttribute('height',height); svg.setAttribute('viewBox',`0 0 ${width} ${height}`);
  const max = Math.max(...filtered.map(f=>f.v),1);
  filtered.forEach((f,i)=>{
    const barW = Math.round((f.v/max) * (width - 200));
    const y = i*36 + 10;
    const label = document.createElementNS(svgNS,'text'); label.setAttribute('x',12); label.setAttribute('y',y+16); label.setAttribute('font-size','12'); label.setAttribute('font-weight','700'); label.textContent = f.k;
    svg.appendChild(label);
    const rect = document.createElementNS(svgNS,'rect'); rect.setAttribute('x',200); rect.setAttribute('y',y+2); rect.setAttribute('width',barW); rect.setAttribute('height',20); rect.setAttribute('rx',6); rect.setAttribute('fill','#c7e9ff');
    svg.appendChild(rect);
    const valText = document.createElementNS(svgNS,'text'); valText.setAttribute('x',200 + barW + 8); valText.setAttribute('y', y+16); valText.setAttribute('font-size','12'); valText.setAttribute('font-weight','700'); valText.textContent = f.v;
    svg.appendChild(valText);
  });
  chart.appendChild(svg);
}

/* Sentiment pie */
function renderSentimentPie(){
  const counts = {Positive:0, Neutral:0, Negative:0};
  state.data.forEach(d=> { if(d.sentiment in counts) counts[d.sentiment]++; else counts.Neutral++; });
  const total = Math.max(1, counts.Positive + counts.Neutral + counts.Negative);
  const pie = document.getElementById('pieChart'); pie.innerHTML='';
  const size = 180; const svgNS = 'http://www.w3.org/2000/svg'; const cx=size/2, cy=size/2, r=size/2-8;
  const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('width',size); svg.setAttribute('height',size); svg.setAttribute('viewBox',`0 0 ${size} ${size}`);
  let start = -Math.PI/2;
  Object.entries(counts).forEach(([k,v])=>{
    const slice = (v/total)*(Math.PI*2);
    const end = start + slice;
    const x1 = cx + r*Math.cos(start), y1 = cy + r*Math.sin(start);
    const x2 = cx + r*Math.cos(end), y2 = cy + r*Math.sin(end);
    const large = slice > Math.PI ? 1 : 0;
    const path = document.createElementNS(svgNS,'path');
    const d = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z`;
    path.setAttribute('d', d); path.setAttribute('fill', SENTIMENT_COLORS[k]);
    svg.appendChild(path);
    start = end;
  });
  pie.appendChild(svg);

  // legend
  const legend = document.getElementById('pieLegend'); legend.innerHTML='';
  Object.entries(counts).forEach(([k,v])=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.marginBottom='6px';
    const sw = document.createElement('div'); sw.style.width='12px'; sw.style.height='12px'; sw.style.borderRadius='4px'; sw.style.background=SENTIMENT_COLORS[k];
    const label = document.createElement('div'); label.style.fontWeight='700'; label.textContent = `${k} â€” ${(v/total*100).toFixed(1)}% (${v})`;
    row.appendChild(sw); row.appendChild(label); legend.appendChild(row);
  });
}

/* Word cloud */
function renderWordCloud(){
  const emotionCounts = {};
  state.data.forEach(r=>{
    // simple heuristics from response text
    const t = (r.comment || '').toLowerCase();
    if(/thank|thanks|gratef|appreciat|love/.test(t)) emotionCounts['Gratitude'] = (emotionCounts['Gratitude']||0)+1;
    if(/angry|hate|annoy|furious|mad|terrible|awful|worst/.test(t)) emotionCounts['Frustration'] = (emotionCounts['Frustration']||0)+1;
    if(/happy|great|excellent|pleased|satisfied/.test(t)) emotionCounts['Satisfaction'] = (emotionCounts['Satisfaction']||0)+1;
    if(/disappointed|sad|upset|not happy|disappoint/.test(t)) emotionCounts['Disappointment'] = (emotionCounts['Disappointment']||0)+1;
    if(/confused|unclear|unsure/.test(t)) emotionCounts['Confusion'] = (emotionCounts['Confusion']||0)+1;
  });
  const wc = document.getElementById('wordCloud'); wc.innerHTML='';
  const total = Object.values(emotionCounts).reduce((a,b)=>a+b,0) || 1;
  Object.entries(emotionCounts).sort((a,b)=>b[1]-a[1]).forEach(([word,count])=>{
    const el = document.createElement('div'); const size = 12 + Math.round((count/total)*22);
    el.style.fontSize = size + 'px'; el.style.background='#e6ffef'; el.style.padding='6px 10px'; el.style.borderRadius='18px';
    el.textContent = `${word} (${count})`.substring(0,30);
    wc.appendChild(el);
  });
}

/* Line chart */
function renderLineChart(){
  const map = {}; MONTH_ORDER.forEach(m=> map[m] = {sum:0,count:0});
  state.data.forEach(r=> { if(map[r.month]){ map[r.month].sum += sentimentScore(r.sentiment); map[r.month].count++; } });
  const points = MONTH_ORDER.map(m=> map[m].count ? map[m].sum/map[m].count : 0);
  const chart = document.getElementById('lineChart'); chart.innerHTML='';
  const width = chart.clientWidth || 380, height = 220, padding = 40;
  const svgNS = 'http://www.w3.org/2000/svg'; const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('width','100%'); svg.setAttribute('height',height); svg.setAttribute('viewBox',`0 0 ${width} ${height}`);
  const yScale = v => padding + ( (1 - (v+1)/2) * (height - padding*2));
  const xScale = i => padding + i * ((width - padding*2) / (MONTH_ORDER.length-1));
  for(let i=0;i<=4;i++){ const y = padding + i*((height - padding*2)/4); const line = document.createElementNS(svgNS,'line'); line.setAttribute('x1',padding); line.setAttribute('x2',width-padding); line.setAttribute('y1',y); line.setAttribute('y2',y); line.setAttribute('stroke','rgba(2,6,23,0.04)'); svg.appendChild(line); }
  MONTH_ORDER.forEach((m,i)=>{ const tx = document.createElementNS(svgNS,'text'); tx.setAttribute('x', xScale(i)); tx.setAttribute('y', height - 8); tx.setAttribute('font-size','10'); tx.setAttribute('text-anchor','middle'); tx.textContent = m; svg.appendChild(tx); });
  const pathD = points.map((p,i)=> `${i===0?'M':'L'} ${xScale(i)} ${yScale(p)}`).join(' ');
  const path = document.createElementNS(svgNS,'path'); path.setAttribute('d', pathD); path.setAttribute('fill','none'); path.setAttribute('stroke','#0b1220'); path.setAttribute('stroke-width','2'); svg.appendChild(path);
  points.forEach((p,i)=>{ const cx = xScale(i), cy = yScale(p); const circle = document.createElementNS(svgNS,'circle'); circle.setAttribute('cx',cx); circle.setAttribute('cy',cy); circle.setAttribute('r',4); circle.setAttribute('fill','#fff'); circle.setAttribute('stroke','#0b1220'); circle.setAttribute('stroke-width',2); svg.appendChild(circle); });
  chart.appendChild(svg);
}

/* Heatmap */
function renderHeatmap(){
  const storeCat = {};
  state.rawData.forEach(r=>{
    const cat = classifyImprovementCategory(r.comment);
    if(cat === 'Miscellaneous') return;
    if(!storeCat[r.storeCode]) storeCat[r.storeCode] = {};
    if(!storeCat[r.storeCode][cat]) storeCat[r.storeCode][cat] = {score:0,count:0};
    storeCat[r.storeCode][cat].score += sentimentScore(r.sentiment);
    storeCat[r.storeCode][cat].count++;
  });
  const storeCounts = {};
  state.rawData.forEach(r=> storeCounts[r.storeCode] = (storeCounts[r.storeCode]||0)+1);
  const topStores = Object.entries(storeCounts).map(([s,c])=>({s,c})).sort((a,b)=>b.c-a.c).slice(0,10).map(x=>x.s);
  const categories = uniq([].concat(...Object.values(storeCat).map(s=>Object.keys(s))));
  const table = document.getElementById('heatmapTable'); table.innerHTML='';
  const thead = document.createElement('thead'); const trh = document.createElement('tr'); const th0 = document.createElement('th'); th0.textContent='Store / Category'; trh.appendChild(th0);
  categories.forEach(cat=>{ const th = document.createElement('th'); th.textContent = cat; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  topStores.forEach(store=>{
    const tr = document.createElement('tr');
    const th = document.createElement('th'); th.textContent = store; th.style.cursor='pointer';
    tr.appendChild(th);
    categories.forEach(cat=>{
      const td = document.createElement('td');
      const stat = storeCat[store] && storeCat[store][cat] ? storeCat[store][cat] : {score:0,count:0};
      const avg = stat.count ? stat.score / stat.count : 0;
      const display = stat.count ? (avg.toFixed(2) + ' (' + stat.count + ')') : '-';
      td.textContent = display;
      const bg = avg > 0 ? `rgba(16,185,129,${Math.min(0.85, Math.abs(avg))})` : avg < 0 ? `rgba(239,68,68,${Math.min(0.85, Math.abs(avg))})` : `rgba(245,158,11,0.08)`;
      td.style.background = bg;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
}

/* Zone chart */
function renderZoneChart(){
  const zoneMap = {};
  state.data.forEach(r=>{ if(!zoneMap[r.zone]) zoneMap[r.zone] = {sum:0,count:0}; zoneMap[r.zone].sum += sentimentScore(r.sentiment); zoneMap[r.zone].count++; });
  const arr = Object.entries(zoneMap).map(([z,v])=>({z,avg: v.count ? v.sum/v.count : 0, count:v.count})).sort((a,b)=>b.avg-a.avg);
  const chart = document.getElementById('zoneChart'); chart.innerHTML='';
  const width = chart.clientWidth || 360; const height = 220; const padding = 30; const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('width','100%'); svg.setAttribute('height',height); svg.setAttribute('viewBox',`0 0 ${width} ${height}`);
  arr.forEach((a,i)=>{ const bw = (width - padding*2) / Math.max(1,arr.length); const barH = ((a.avg + 1)/2) * (height - padding*2); const x = padding + i*bw + 6; const y = height - padding - barH; const rect = document.createElementNS(svgNS,'rect'); rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width',Math.max(12,bw-18)); rect.setAttribute('height',barH); rect.setAttribute('rx',8); rect.setAttribute('fill', a.avg > 0 ? SENTIMENT_COLORS.Positive : (a.avg < 0 ? SENTIMENT_COLORS.Negative : SENTIMENT_COLORS.Neutral)); svg.appendChild(rect); const label = document.createElementNS(svgNS,'text'); label.setAttribute('x', x + (Math.max(12,bw-18))/2); label.setAttribute('y', height - 8); label.setAttribute('font-size','11'); label.setAttribute('text-anchor','middle'); label.textContent = a.z; svg.appendChild(label); });
  chart.appendChild(svg);
}

/* Comments rendering */
function renderComments(){
  const data = state.data.map(r=> ({...r, parsedDate: new Date(r.commentDate)})).sort((a,b)=> b.parsedDate - a.parsedDate);
  const positives = data.filter(r=> r.sentiment==='Positive').slice(0,15);
  const negatives = data.filter(r=> r.sentiment==='Negative').slice(0,15);
  const posWrap = document.getElementById('positiveComments'); posWrap.innerHTML='';
  positives.forEach(r=>{
    const card = document.createElement('div'); card.className='comment-card';
    card.innerHTML = `<div style="font-size:14px"><span style="margin-right:8px">ðŸ˜Š</span><b>${escapeHtml(r.comment)}</b></div><div style="font-size:12px;color:var(--muted);margin-top:6px">Store: ${escapeHtml(r.storeCode)} | Date: ${escapeHtml(r.commentDate)}</div>`;
    posWrap.appendChild(card);
  });
  const negWrap = document.getElementById('negativeComments'); negWrap.innerHTML='';
  negatives.forEach(r=>{
    const card = document.createElement('div'); card.className='comment-card';
    card.innerHTML = `<div style="font-size:14px"><span style="margin-right:8px">ðŸ˜ </span><b>${escapeHtml(r.comment)}</b></div><div style="font-size:12px;color:var(--muted);margin-top:6px">Store: ${escapeHtml(r.storeCode)} | Date: ${escapeHtml(r.commentDate)}</div>`;
    negWrap.appendChild(card);
  });
}

/* Render everything */
function renderEverything(){
  applyFilters();
  renderKPIsAndInsights();
  renderDriversChart();
  renderSentimentPie();
  renderWordCloud();
  renderLineChart();
  renderHeatmap();
  renderZoneChart();
  renderComments();
}

/* CSV download */
function downloadFilteredCSV(){
  if(!state.data.length){ alert('No data to download.'); return; }
  const cols = ['storeCode','businessName','zone','state','city','mallType','fy','quarter','month','rating','sentiment','commentDate','comment'];
  const header = cols.join(',');
  const lines = state.data.map(r => cols.map(c => {
    const v = (r[c] === undefined || r[c] === null) ? '' : String(r[c]).replace(/"/g,'""');
    return `"${v}"`;
  }).join(','));
  const csv = [header].concat(lines).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'voc_filtered.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* Drawer open/close */
const drawerBackdrop = document.getElementById('drawerBackdrop');
document.getElementById('openFilters').addEventListener('click', ()=> { drawerBackdrop.style.display='flex'; renderFilterControls(); });
document.getElementById('closeDrawer').addEventListener('click', ()=> { drawerBackdrop.style.display='none'; });
drawerBackdrop.addEventListener('click', (e)=> { if(e.target === drawerBackdrop) drawerBackdrop.style.display='none'; });

/* collapsible toggles inside drawer */
document.addEventListener('click', (e)=>{
  const t = e.target;
  if(t.matches('.collapsible h4') || t.closest('.collapsible h4')){
    const head = t.matches('.collapsible h4') ? t : t.closest('.collapsible h4');
    const content = head.nextElementSibling;
    if(content) content.style.display = (content.style.display === 'none' || !content.style.display) ? 'block' : 'none';
  }
});

/* Wire apply/reset buttons */
document.getElementById('applyFilters').addEventListener('click', ()=> { drawerBackdrop.style.display='none'; renderEverything(); });
document.getElementById('resetFilters').addEventListener('click', ()=>{
  state.filters = { businessName:null, zones:new Set(), states:new Set(), cities:new Set(), stores:new Set() };
  renderFilterControls();
  renderEverything();
});

/* Download CSV binding */
document.getElementById('downloadCsvBtn').addEventListener('click', downloadFilteredCSV);

/* Initialization */
(async function init(){
  const raw = await loadReviewData();
  state.rawData = raw.map(r=> normalizeRecord(r));
  // ensure months uppercase
  state.rawData.forEach(r=> r.month = (r.month||'').toString().toUpperCase());
  refreshDerivedLists(state.rawData);
  // no default filters to keep all visible
  renderFilterControls();
  renderEverything();
})();
</script>
</body>
</html>
